---

title: System, method and program product to route message packets
abstract: A system, method and computer program for routing a response packet in a session along a path similar to a request packet's outbound path that includes a firewall and a first router. The firewall receives the request packet and forwards the request packet to the first router. Upon receipt of the request packet, the firewall and first router broadcast session information to their respective sets of directly connected devices. A second router receives the response packet. After determining that the second router was not in the outbound path according to the second router's session table, the second router forwards the response packet to the device (i.e., the firewall or the first router) that is most upstream in the outbound path among the outbound path devices that are available and connected to the second router.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07747776&OS=07747776&RS=07747776
owner: International Business Machines Corporation
number: 07747776
owner_city: Armonk
owner_country: US
publication_date: 20080801
---
This application is a continuation application claiming priority to Ser. No. 11 015 165 filed Dec. 17 2004.

The invention relates generally to computer systems and deals more particularly with a technique to route message packets.

Digital communication today often uses protocols such as TCP IP in which a message is divided into packets. Each of the packets includes a portion of the message along with a header that indicates a destination and sequence number of the packet in the message. The packets are routed from a source node via one or more intermediary firewalls and routers to the destination node. The source node may reside in a network protected by the firewall to filter out unwanted messages. In such a case the firewall is located between the network which it protects and the Internet or other routers and network s leading to the destination node. For firewall load balancing high availability and other purpose there may be two or more firewalls for a single network. There are often many possible routes i.e. series of routers between the source node or source network and the destination node or destination network.

With an asynchronous routing protocol such as TCP IP it is common for the request message packets to traverse one route from the source to the destination and the response message packets to traverse a different route from the destination to the source. Each route is typically based on a routing table within each router and firewall. In such cases where there is an asynchronous routing protocol and more than one firewall for the source node or source network it is possible for the request message packets to exit the network through one firewall for the source and the response message packets to arrive at another firewall for the source.

In the TCP IP protocol when the request message packets exit the source node or source network via one of the firewalls this firewall records a session ID under which the request message packets are being sent. The response message packets will include the same session ID. However if the response message packets arrive at another firewall even another firewall for the source node or source network of the original message packets this other firewall may not recognize the response message session ID. In such a case this other firewall will not forward the response message packets to the source node or source network of the request message packets.

SIN indicates that the message is an original request such as a request for information or action not a response to another message.

RST is a request to reestablish the connection because something has gone wrong with the original connection.

Session ID is the identification of the session and is included in all message packets both those from user computer to server and those from server to user .

SINACT indicates that the packet is a response message packet and contains part or all of the data responsive to the complete request message. This is the data generated by the destination server after it receives and handles the complete message received from the user computer. By way of example the data can be a web page in the case where destination server is a web server.

The following illustrates an example according to a prior art return routing which illustrates the problem with the prior art. The message sent from user computer passed through firewall so firewall not firewall recorded the state information. After the request message packet was forwarded to destination server via router router and firewall destination server creates a responsive message. This responsive message comprises a number of message packets each with source IP address 10.1.1.5 and destination IP address 10.0.0.4. There is a message routing table within the server computer based on the configuration of server computer which sends each message packet to Virtual Routing Redundant Protocol VRRP address 10.1.1.1. This VRRP address is the virtual IP address of either firewall or firewall determined as follows. Firewalls and previously negotiated between them as to which one will handle route message packets with VRRP 10.1.1.1 as long as this firewall is active. However if the designated firewall goes down and does not respond to a heartbeat message sent from the other firewall then the other firewall will handle the message packet with VRRP virtual address 10.1.1.1. In the illustrated example firewall is currently the active firewall as between firewalls and and is configured to receive message packets with VRRP virtual addressed 10.1.1.1. So firewall receives the message packet from server computer .

As explained above firewall has a routing table which specifies a routing path to the response destination IP address i.e. the IP address of computer or at least the next hop router or firewall to send the response message packets toward the response destination IP address i.e. the IP address of computer . This table can be compiled using well known OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. In the illustrated example the table indicates that router is the next hop router so firewall sends the message packet to router . Likewise as explained above router has a table which specifies a path to the response destination IP address or at least the next hop router or firewall to send the message packet toward the response destination IP address. This table can also be compiled using OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. In the illustrated example the table indicates that router is the next hop router so router sends the message packet to router . It may be the case that the communication path from router to router is down or congested or for some other reason slower than the path to router so the table in router selects router as the next hop. Likewise router has a table which specifies a path to the response destination IP address or at least the next hop router or firewall to send the message packets toward the destination IP address. This table can also be compiled using OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. In the illustrated example the table indicates that firewall is the next hop firewall so router sends the message packet to firewall .

As noted above firewalls and are both stateful for security reasons they restrict handling and forwarding of certain response message packets to those with session IDs known to the firewall based on handling of the request message packets. In a restrictive example firewall will only handle and forward responsive type message packets which are a response to message packets that previously resulted from a session with user computer where the firewall knows of the session. In many cases this is too restrictive so firewalls and can be configured as stateful for certain types of response messages but not others. For example response message packets sent to certain applications within user computer may be limited based on session IDs known to the firewall which receives the response message packet but response message packets sent to other applications within user computer may not be so limited by their session ID. In either scenario whenever firewall or receives a message packet that does not include a SIN FIN RST or ACK indicator the firewall assumes the message packet is a response to a request message sent previously. So firewall upon receipt of the response message packet checks its list of session IDs of active sessions to determine if firewall forwarded the previous corresponding request message packets. If so i.e. the stateful firewall has a record of this session ID and the firewall will forward it to the next hop in this case user computer . However in the illustrated example the stateful firewall does not have a record of this session ID because the original request message packet from user computer went through firewall so firewall will discard the message packet i.e. erase it and not forward it to user computer or anywhere else. Consequently user computer does not receive this responsive message packet from server computer .

It was previously known for each firewall of a firewall cluster to notify the other firewalls in the cluster of every session of which it learns through receipt of an outbound request message packet. Consequently if a responsive message packet arrives at a stateful firewall which did not handle the outbound request message packets this firewall will still recognize the session so the firewall can accept the message packet and forward it to the destination.

For some applications where uniform quality of service is required it is desirable for all the packets of a message to follow the same or nearly the same path from a source to a destination to the extent the path is available. However the routing tables in the firewalls and routers will continually strive to select the fastest path and will avoid routers and firewalls which are down or congested. While the fastest path may be desirable in many circumstances for uniform quality of service path consistency may be preferred.

It was also previously known to attempt to cause a response message packet to follow the same path used by the outbound request message. However in some cases one or more routers or firewalls in this path are unavailable so it is not possible for the response message to follow the same path used by the outbound request message. In such a case a TCP IP communication program which utilizes the VRRP protocol will learn of the failure of this device when the failed device does not respond to its periodic hello message. Then the TCP IP communication program will update its routing tables accordingly to prevent the message from being sent to the failed device again unless the failed device responds to a subsequent hello message .

An object of the present invention is to provide a system method and program to route response message packets along a same or similar path as used by the outbound request message packets in the same session to the extent practical.

The invention resides in a system method and computer program for routing a response message packet. The response message packet is a response to a request message packet which traveled along an outbound path from a source computer to a destination computer. The outbound path comprises a first firewall for the source computer and a first router coupled to the first firewall. In response to the first firewall receiving the request message packet the firewall broadcasts to a first plurality of peer firewall s and or router s a session of the request message packet and an identity of the firewall. In response the first plurality of peer firewall s and or router s records the session of the request message packet and that the first firewall was a first hop in the outbound path. The first firewall forwards the request message packet to the first router. In response the first router broadcasts to a second plurality of peer firewall s and or router s a session of the message packet and an identity of the first router. In response the second plurality of peer firewall s and or router s records the session of the request message packet and that the first router was a second hop in the outbound path. In response to a second router of the second plurality of peer firewall s and or router s receiving the response message packet the second router a compares a session of the response message packet indicated by the response message packet to the second router s record of the session of the request message packet b determines from the record that the first firewall or the first router was in the outbound path and c forwards the response message packet to the first firewall or the first router. The second router was not in the outbound path.

According to one feature of the present invention the second router is also one of the first plurality of peer firewall s and or router s . In response to the second router receiving the response message packet the second router forwards the response message packet to the first firewall.

According to other features of the present invention in response to the first router receiving the request message packet the first router records the session of the request message packet and that the first firewall was a previous hop in the outbound path. In response to the first router receiving the response message packet the first router checks its record to learn that the first firewall was the previous hop in the outbound path and then forwards the response message packet to the first firewall. The first router periodically sends signals to the second plurality of peer firewall s and or router s indicating that the first router is active. The first router was inactive when the second router receives the response message packet and fails to send a signal indicating that the first router is active prior to the second router receiving the response message packet. In response the second router forwards the message packet to the first firewall.

According to another feature of the present invention after the first router receives the request message packet from the first firewall and before the response message packet is generated the first router forwards the request message packet to a third router in the outbound path. In response the third router broadcasts to a third plurality of peer firewall s and or router s a session of the message packet and an identity of the third router. In response the third plurality of peer firewall s and or router s records the session of the request message packet and that the third router was a third hop in the outbound path.

The present invention will now be described in detail with reference to A and B . illustrates user computer or node on a network . By way of example network is a LAN WAN MAN or the Internet. also illustrates firewalls and for network . Among other things firewalls and filter unwanted message packets en route to network and filter some outgoing message packets as well. Firewalls and also include respective router functions to route message packets to a destination IP address if the destination address is adjacent to the firewall or to a next hop router en route to a destination IP address if the destination address is not adjacent to the firewall or . In the illustrated example the destination address server is not adjacent to either firewall or so firewalls and cannot route message packets directly to the destination address. Instead firewalls and route the message packets through adjacent intermediary next hop routers such as routers and as described below. illustrates through solid and broken lines that firewall is directly connected to both routers and and that firewall is directly connected to both routers and . However in the illustrated example based on firewall s routing table at the current time firewall uses router for outbound message packets en route to server and based on firewall s routing table at the current time firewall uses router for outbound message packets en route to server . also illustrates routers and which among other things route message packets to a destination address if the destination address is directly connected or to a next hop router or firewall en route to a destination IP address if the destination address is not directly connected. In the illustrated example routers and are not directly connected to destination server . also illustrates server on network . By way of example network is a LAN WAN MAN or the Internet. also illustrates firewalls and for network . Among other things firewalls and filter unwanted message packets en route to network and filter some outbound message packets from network . Firewalls and also include respective router functions to route message packets to a destination IP address if the destination address is directly connected to the firewall or to a next hop router en route to a destination IP address if the destination address is not directly connected to the firewall. Each of the firewalls and is directly connected to destination server .

Each of the firewalls and and routers and also includes known hardware and or software to periodically send keep alive signals to their respective peers step of . These keep alive signals indicate that the sending device i.e. firewalls and and routers and is still alive active. If a device fails to send a keep alive signal for a certain period of time then its peers will assume that the device is down remove the device from the routing table and replace the device with another active device leading to a listed destination i.e. determine a productive path around the down device. Each of the firewalls and and routers and also includes hardware and or software according to the present invention which a broadcasts session information about message packets they receive and b uses the session information broadcast from other routers and firewalls to ensure that the message packets are reliably forwarded to the intended destination. This process is described in more detail below with reference to .

In the illustrated example a user creates a message at user computer or an application in user computer creates a message and known networking hardware and software within user computer divides the message into packets for network transmission. In the illustrated example each packet has source IP address 10.0.0.4 destination IP address 10.1.1.5 other header information and part of the message data. In this standard naming convention 10.0.0 represents network on which user computer resides and .4 represents user computer . Likewise 10.1.1. represents network on which server resides and .5 represents server . There is a message routing table within user computer based on the configuration of user computer which sends this message packet to Virtual Routing Redundant Protocol VRRP address 10.0.0.1. This VRRP address is the virtual IP address of either firewall or firewall determined as follows. Firewalls and previously negotiated between themselves as to which one will handle route message packets with VRRP 10.0.0.1. If that firewall or goes down and does not respond to a heartbeat message sent from the other firewall then the other firewall will handle the message packet with VRRP virtual address 10.0.0.1 or 10.1.1.X. In the illustrated example firewall is currently the active firewall as between firewalls and configured to receive message packets with VRRP virtual addressed 10.0.0.1 or 10.1.1.X. So firewall receives the foregoing message packet from user computer step .

SIN indicates that the message is an original outbound request message packet such as a request for information or action not a response to another message.

FIN indicates that the message is outbound and not original unless a single packet message and that the sender is finished with the connection so the session can be terminated.

RST indicates that the message is outbound or inbound and is a request to reestablish the connection because something has gone wrong with the original connection.

ACK indicates a response message and is an acknowledgment that a request message packet was received. There can be one acknowledgment packet for each request packet each x number of request packets or entire request message when completely received . This is negotiated at the TCP IP layer between the user computer and server computer .

Session ID indicates the ID of the session and is included in all message packets both those from user computer to server and those from server to user .

SINACK indicates that the packet contains part or all of the data responsive to the complete request message. This is the data generated by server after it receives and handles the complete message received from user computer . By way of example the data can be a web page in the case where server is a web server.

The following steps of apply when the message packet is an outbound request message packet. Steps are repeated see step for each firewall and router between source computer and destination server that handles the outbound request message packet en route to server . When firewall receives the request message packet firewall parses the header to learn that this is a request message packet as indicated by the SIN FIN or RST parameters and to learn the session information step . The session information comprises the session ID packet sequence number source IP address and destination IP address. The session information also indicates that firewall received the message packet as a hop in the outbound message path. The session ID is for the session opened by user computer with server . In such a case the first request message from user computer to server can be to establish the session. Subsequent requests in this same session can be requests from user computer for data from server . As explained above a single message may have been divided into multiple packets so the packet sequence number identifies the position of each packet in the message. In TCP IP the session remains active under normal operating conditions until the firewall receives the response from the destination server. However if the destination server does not respond within a predetermined amount of time the session will time out. After parsing the session information firewall broadcasts to its peers the session information i.e. its own IP address the session ID source IP address destination IP address and a date time stamp of the original broadcast by the device step . The IP address of firewall in the session information indicates that firewall received the actual request message packet. In other words the IP address of firewall in the session information indicates that firewall was a hop in the outbound request packet path. The peers are the directly connected routers and firewalls. In the illustrated example firewall router and router are the peers of firewall . Firewall periodically rebroadcasts the session information to its peers for the benefit of any of the peers that were not running during the initial broadcast. On startup of each peer router or firewall and thereafter each router and firewall listens for such broadcasted session information and makes a corresponding entry in a session table step . For each session the session table in each router and firewall lists the session ID source IP address destination IP address IP address of the router or firewall that broadcast the session information and date time stamp. Firewall also includes a session table which firewall updates with the session information step . Firewall also has a routing table which specifies a path to the destination IP address i.e. server or at least the next hop router or firewall to send the message packets toward the destination IP address. This routing table can be compiled using well known OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. This routing table in firewall is prior art. After broadcasting the session information to its peers and the peers making entries in their session tables to indicate firewall as a recipient of the message packet and broadcaster of the session information and supplemented its own session table firewall sends the request message packet to the next hop router indicated by the routing table step . In the illustrated example the routing table of firewall indicates that router is the next hop router so firewall sends the request message packet to router .

The foregoing steps are repeated for router . In response to the request message packet sent by firewall to router router parses the header to learn that this is a request message packet as indicated by the SIN FIN or REST parameters and to learn the session information step . This session information comprises the session ID packet sequence number source IP address and destination IP address. The session information also indicates that firewall was the previous hop of the session information. Then router broadcasts the session information to all its peers step and the peers record the session information in their respective session tables step . The session information broadcast by router and recorded by its peers comprises the broadcaster s IP address in this case router s IP address the source IP address the destination IP address the session ID and date time stamp of original broadcast by router . In the illustrated example firewall firewall router router and router are the peers although typically there are more peers . So the session tables in firewall and router and the peers that received the broadcast from both firewall and router indicate both hops of the outbound request message path and the order of the hops based on the respective date time stamps . The session tables in routers and will only record the router hop in the outbound request message path because routers and were not peers of firewall . In addition to broadcasting the session information router enters the session information into its session table including an indication that it was the next hop after firewall step . Router also has a routing table which specifies a path to the destination IP address or at least the next hop router or firewall to send the message packets toward the destination IP address. This routing table can be compiled using well known OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. This routing table in router is prior art. After broadcasting the foregoing session information to its peers and the peers making entries in their session tables and recording the session information in its own session table router sends the request message packet to the next hop router indicated by the routing table step . In the illustrated example the routing table of router indicates that router is the next hop router so router sends the request message packet to router .

The foregoing steps are repeated for router . In response to the message packet sent by router to router router parses the header to learn that this is a request message packet as indicated by the SIN FIN or REST parameters and to learn the session information step . This session information comprises the session ID packet sequence number source IP address and destination IP address. The session information also indicates that router was the next hop in the outbound message packet path. Then router broadcasts the session information to all its peers step and the peers record the session information in their respective session tables step . The session information broadcast by router and recorded by its peers comprises the broadcaster s IP address in this case router s IP address the source IP address the destination IP address the session ID and date time stamp of original broadcast by router . In the illustrated example router firewall router router and firewall are the peers. The session tables in router and router and any other peers that received the broadcast from firewall router and router indicate all three hops of the outbound request message packet and the order of the hops based on the respective date time stamps . Firewall is not directly connected to either firewall or router so firewall at this time only has a record of the receipt by router of the outbound request message packet and the broadcast by router of the session information. In addition to broadcasting the session information router enters the session information into its session table including an indication that it was the next hop after router step . Router also has a routing table which specifies a path to the destination IP address or at least the next hop router or firewall to send the message packets toward the destination IP address. This routing table can be compiled using well known OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. This routing table in router is prior art. After broadcasting the foregoing session information to its peers and the peers making entries in their session tables router sends the message packet to the next hop router indicated by the routing table step . In the illustrated example the routing table of router indicates that firewall is the next hop router so router sends the request message packet to firewall .

The foregoing steps are repeated for firewall . In response to the request message packet sent by router to firewall firewall parses the header to learn that this is a request message packet as indicated by the SIN FIN or RST parameters and to learn the session information step . This session information comprises the session ID packet sequence number source IP address and destination IP address. The session information also indicates that router was the previous hop of the request message packet. Then firewall broadcasts the session information to all its peers step and the peers record the session information in their respective session tables step . The session information broadcast by firewall and recorded by its peers comprises the broadcaster s IP address in this case firewall s IP address the source IP address the destination IP address the session ID and date time stamp of original broadcast by firewall . In the illustrated example router router and firewall are the peers. In addition the session tables of the routers and firewalls that also received broadcasts from firewall router and or router will include additional session information for these broadcasts. The additional information indicates other segments of the outbound request message path. In the illustrated example the session tables in router router and firewall will indicate the previous hop of the outbound message path through router . The session table in router and router will also indicate the previous hop of the outbound message through router and the order of the hops based on the respective date time stamps . Firewall is not directly connected to firewall or router so firewall at this time only has a record of the receipt by router of the outbound request message packet and the broadcast by router of the session information. In addition to broadcasting the session information firewall then enters the session information into its session table including an indication that it was the next hop after router step . Firewall also has a routing table which specifies a path to the destination IP address or at least the next hop router firewall or destination server to send the message packets toward the destination IP address. This routing table can be compiled using well known OSPF RIP EIGRP IGRP BGP STATIC or IS IS routing protocol. This routing table in firewall is prior art. After broadcasting the foregoing session information to its peers and the peers making entries in their session tables and firewall supplementing its session table firewall sends the message packet to the next hop indicated by the routing table step . In the illustrated example the routing table of firewall indicates that server is the next hop so firewall sends the request message packet to server .

Upon receipt of the foregoing request message packet server processes the request message packet step . Server may generate an acknowledgment response message packet indicating that the foregoing request message packet was received step . In such a case server initiates sending of the acknowledgment message packet to user computer as described below with reference to . If this is the last message packet to form an entire request message server also reads and handles the request. The request may be for data or another service. After handling the request server generates a responsive message which generally includes data step and divides the responsive message into one or more packets. Response packets are transmitted to computer as described below with reference to .

The following steps illustrated in apply for either type of response message packet and are performed by each firewall and router between server and computer that receives the response message packet en route to computer . In the illustrated example the first response message packet is generated by server and sent to firewall as follows. This responsive message comprises one or more message packets each with source IP address 10.1.1.5 and destination IP address 10.0.0.4. The acknowledge message is typically a single packet whereas the substantive response to a complete request message is typically multiple packets. In the preferred embodiment of the present invention server does not have or use a session table and does not record the path taken by the outbound request message packet. Instead there is a known message routing table within the server computer based on the configuration of server computer which sends each message packet to Virtual Routing Redundant Protocol VRRP address 10.1.1.1. This VRRP address is the virtual IP address of either firewall or firewall determined as follows. Firewalls and previously negotiated between them as to which one will handle route message packets with VRRP 10.1.1.1 as long as this firewall is active. However if the designated firewall goes down and does not respond to a heartbeat message sent from the other firewall then the other firewall will handle the message packet with VRRP virtual address 10.1.1.1. In the illustrated example firewall is currently the active firewall as between firewalls and and is configured to receive message packets with VRRP virtual address 10.1.1.1. So firewall receives the response message packet from server computer . The response message packet will include an ACK or SINACK parameter in its header.

Where the message packet is a response message packet as indicated by the ACK or SINACK parameter firewall parses the message packet header to learn that this is a response message packet and to learn the session ID of the message packet step . Then firewall checks its session table to determine if firewall has a record of this session decision either from previously receiving a message packet in this session or receiving a broadcast of the session information for this session. In the illustrated example firewall should have a record of this session in its session table from the previous broadcast from router and also from subsequently receiving the outbound request message packet in this session. This record should indicate that router was the previous hop of the outbound request message packet before arriving at firewall i.e. router was in the outbound request message path decision yes branch . In other words the session table in firewall indicates that router previously forwarded to firewall the outbound request message packet for which the current message packet is a response packet. In accordance with the present invention the same path should be followed in reverse by the response message packet if practical. If router is active firewall forwards the response message packet to router step first decision . However if router is not active step second decision as indicated by the lack of a keep alive signal for a predetermined period then firewall will instead forward the response message packet to the next hop indicated by the routing table of firewall as described below. 

After receiving the response message packet from router router parses the message packet header to learn that this is a response message packet and to learn the session information of the message packet step . Then router checks its session table to determine if router has a record of this session decision either from previously receiving a message packet in this session or receiving a broadcast of the session information for this session. In the illustrated example router should have a record of this session in its session table from the previous broadcast from firewall and also from subsequently receiving the outbound request message packet in this session. This record should indicate firewall was the previous hop of the outbound request message packet before arriving at router . In other words the session table in router indicates firewall previously forwarded to router the outbound request message packet for which the current message packet is a response packet decision yes branch . In accordance with the present invention the same path should be followed in reverse by the response message packet if possible. So router forwards the response message packet to firewall . However if firewall is not active step second decision as indicated by the lack of a keep alive signal for a predetermined period then router will forward the response message packet to the next hop indicated by the routing table of router . 

After receiving the response message packet from router firewall parses the message packet header to learn that this is a response message packet and the session information of the message packet step . Then firewall checks its session table to determine if firewall has a record of this session decision either from previously receiving a message packet in this session or receiving a broadcast of the session information for this session. In the illustrated example firewall should have a record of this session in its session table from receiving the outbound request message packet in this session. This record should indicate that computer was the previous hop source of the outbound request message packet before arriving at firewall . In other words the session table in firewall indicates that computer previously forwarded to firewall the outbound request message packet for which the current response message packet is a response packet decision yes branch . In accordance with the present invention the same path should be followed in reverse by the response packet if possible. So firewall forwards the response message packet to computer .

The foregoing processing by firewall router router and firewall of the response message packet occur when there are no problems with the outbound message packet path for the response packet i.e. all of the firewalls and routers in this path are active. The following are examples where one or more of the firewalls and routers in this path are not active for the response message packet 

Consider the case where server initially forwards the response message packet to firewall instead of firewall based on unavailability of firewall or renegotiation of the active firewall as between firewalls and . In such a case firewall determines from the header that this is a response message packet step checks its session table for an entry for this session step and learns that firewall was not in the outbound request message path decision no branch . Instead firewall learns that firewall was the last hop in the outbound request message path and router was the next to last hop in the outbound request message packet path. Firewall does not have visibility further upstream in the outbound request message path because firewall did not receive the outbound message broadcasts from either firewall or router . In one embodiment of the present invention indicated by a routing configuration option in firewall because firewall is directly connected to router and assuming router is still alive decision yes branch firewall can forward the response message packet to router bypassing firewall . This would return the response message packet to the proper outbound message path step . However if router is not active or based on another embodiment of the present invention indicated by the routing configuration option in firewall firewall will send the response message packet to firewall assuming firewall is alive step . Firewall will then check its session table step learn that firewall was in the outbound message path decision yes branch and then forward the response message packet to the previous hop in the outbound message path indicated by the session table i.e. router step . If neither router nor firewall is alive then firewall will forward the response message packet to the next hop indicated by the routing table within firewall step . In the illustrated example assume this is router although it could be router . Upon receipt of the response message packet router will check its session table for the session ID steps and . In the illustrated example router will have an entry for this session in its session table based on the previous broadcasts by firewall router and router resulting from the outbound request message packet in the same session. Then in one embodiment of the present invention as indicated by the routing configuration option router will forward the response message packet to the most upstream device in the outbound request path decision yes branch and step . In the illustrated example this will be router decision no branch decision yes branch and step . In another embodiment of the present invention as indicated by the routing configuration option router will forward the response message packet to a downstream device in the outbound request path.

Consider the case where router receives the message packet from either firewall or but forwards the response message packet to router instead of router based on unavailability of router as indicated by the absence of the keep alive signal from router . In such a case router checks its session table for an entry for this session steps and and learns that router was not in the outbound request message path decision no branch . Instead router learns that router was the last hop before the sender of the response message packet i.e. router and firewall was the next to last hop in the outbound request message packet path. Router does not have visibility further upstream in the outbound request message path to computer . Because router is directly connected to firewall and assuming firewall is still alive router can forward the response message packet to firewall decision yes branch and step and this would return the response message packet to the proper outbound message path. If router was not directly connected to firewall or any other firewall or router in the outbound request path decision no branch unlike the illustrated embodiment router will send the response message packet to router if router is now alive step . If neither router nor firewall is now alive then router will forward the response message packet to the next hop indicated by the routing table within router step . In the illustrated example this will be firewall . Upon receipt of the response message packet firewall will check its session table for the session ID step . In the illustrated example firewall will have an entry for this session in its session table based on the previous broadcast by firewall resulting from the outbound request message packet in the same session step . Then firewall will forward the message packet to the most upstream device in the outbound request path. In the illustrated example this will be computer . Alternately as indicated by a routing configuration option firewall can forward the message packet to firewall to return the response message packet to the outbound message path if firewall is alive step .

Consider another example where the response message packet arrives at firewall instead of firewall . This could occur in a number of scenarios. For example in the case where server originally forwarded the response message packet to firewall and both firewall and router were down. Assuming that the routing table in firewall indicated router as the next hop and router does not have an entry in its session table for this session because router is not directly connected to any of firewall router router or firewall and did not receive their broadcasts during the outbound request message packet routing . Router is directly connected to both firewalls and decision no branch and decision yes branch but the routing table in router indicates firewall as the next hop. So when the response message packet arrives at firewall firewall will check its session table to learn that the most upstream hop in the outbound request message packet path was firewall so firewall can forward the response message packet to firewall step . In response firewall will check its session table to learn that it has a record of this session and can accept this message packet as a legitimate response to an outbound request message packet and then forward the response message packet to computer as indicated in the session table in firewall . Alternately because firewall has the session information for this message packet firewall can accept the message packet as a legitimate response to an outbound request message packet and forward it directly to computer based on the session table within firewall step .

Based on the foregoing a system method and program product for routing response message packets along the outbound request message path to the extent available has been disclosed. However numerous modifications and substitutions can be made without deviating from the scope of the present invention. Therefore the present invention has been disclosed by way of illustration and not limitation and reference should be made to the following claims to determine the scope of the present invention.

