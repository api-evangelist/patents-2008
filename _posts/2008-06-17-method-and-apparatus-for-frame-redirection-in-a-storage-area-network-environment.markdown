---

title: Method and apparatus for frame redirection in a storage area network environment
abstract: Embodiments according to the invention relate to frame redirection, which includes methods to intercept and re-route traffic between an initiator and a target. When a frame is redirected, an initiator issues a frame to the target, but the frame is received by a virtual target in a redirection switch by allowing the redirection switch to use the WWN of the actual target. From the perspective of the initiator, the target resides on the redirection switch. From the redirection switch, the frame is sent to the actual target by allowing the redirection switch to use the identity of the initiator. In other words, the redirection switch presents the WWN of the initiator to the target when the redirected frame is sent to the target. From the perspective of the target, the frame is received as if it originated at the initiator.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08050261&OS=08050261&RS=08050261
owner: Brocade Communications Systems, Inc.
number: 08050261
owner_city: San Jose
owner_country: US
publication_date: 20080617
---
Embodiments according to the invention relate to a method and apparatus for frame redirection in a Storage Area Network SAN environment. More particularly embodiments according to the invention relate to frame redirection which includes methods to intercept and re route traffic between an initiator and a target.

This application is related to U.S. patent application Ser. No. 10 695 408 the contents of which are incorporated by reference.

Effectively deploying multiple devices in a network environment becomes an increasingly complex task as transmission data rates processor speeds and storage capacities increase. Storage area networks SANs have been developed as specialized high speed networks referred to as fabrics to connect computer systems control software and storage devices over the fabric. A SAN typically allows block level input output I O rather than file level access. Thus every device connected to a SAN fabric appears as a locally attached device to other devices on the fabric.

A SAN allows for relatively simple interchangeability of components with minimal disruptions to other components as discussed above. However as the size of a SAN increases and correspondingly storage needs on the SAN increase it becomes beneficial to merge resources such as storage devices into single logical devices making it easier for hosts to access the storage devices . One such method of merging resources is addressed through virtualization. In general terms virtualization is a process used to collect storage resources into a pool and hand out logical slices to hosts without any reconfiguration on the host side or on the storage side. Then through modifications to the host switch or storage devices or some combination thereof traffic intended to pass from an initiator e.g. host to a target e.g. storage device is re routed to a virtual target and on to the defined physical target or targets.

Storage virtualization provides to computer systems a separate independent view of storage from the actual physical storage. A computer system e.g. a host sees a virtual disk. As far as the host is concerned this virtual disk appears to be an ordinary SCSI disk logical unit. However this virtual disk does not exist in any physical sense as a real disk drive or as a logical unit presented by an array controller. Instead the storage for the virtual disk is taken from portions of one or more logical units available for virtualization the storage pool . This separation of the hosts view of disks from the physical storage allows the host s view and the physical storage components to be managed independently from each other. For example from the host perspective a virtual disk s size can be changed assuming the host supports this change its redundancy RAID attributes can be changed and the physical logical units that store the virtual disk s data can be changed without the need to manage any physical components. These changes can be made while the virtual disk is online and available to hosts. Similarly physical storage components can be added removed and managed without any need to manage the hosts view of virtual disks and without taking any data offline.

Numerous implementations for virtualization exist. For example logical unit number LUN masking may be employed to prevent each host from accessing storage resources that it is not permitted to use. In general terms LUN masking makes particular LUNs available to some hosts but unavailable to others. LUN masking filters are typically installed as specialty software e.g. a device driver on each host. Although this software may be configured from a centralized management application ultimately each host is responsible for maintaining a proper configuration for LUN masking.

Other methods for virtualization exist. For example specialized devices may be used in band between hosts and storage devices to provide virtualized storage to the hosts. One example of a fabric enabled for in band storage virtualization i.e. routing network traffic from a host to a storage device via a Fibre Channel switch is shown in . As shown in a host has among other elements a host bus adapter HBA . Conventionally the HBA is a daughter board connected to the host . Each HBA connects a host to other network and storage devices on the fabric via the Fibre Channel switch . As is known in the art each HBA has a World Wide Name WWN which is a unique identifier assigned to each Fibre Channel device. A WWN identifies the HBA and thus the respective host to the Fibre Channel switch and other devices on the fabric . The storage devices also have unique WWNs. On the switch side each device is connected to a particular port and is identified by a port identifier PID . The PID identifies the physical switch and the port to which each network device is attached. As a PID is dependent on the switch a PID may change in certain situations.

The Fibre Channel switch includes a virtualization processor and a name server which stores information about all devices in the fabric . Typically a name server operates on each Fibre Channel switch in the fabric . The virtualization processor creates virtual devices to interface between the host and the physical storage . Virtualization of SAN devices accelerates replacement of storage devices and HBAs. SAN devices can be virtualized as initiators or targets to create virtual targets or virtual initiators. The logical units of the virtual target correspond to volumes as defined by the volume manager . The first and second virtual logic units map to the physical storage devices respectively. The virtual target appears as a normal Fibre Channel Protocol FCP device to the host . The host discovers the virtual target through a fabric directory service.

Virtualization may best be understood by of describing an example frame intended to pass from the host i.e. the initiator to the storage device the target using a translation operation such as data mirroring to back up the data on the storage device . In this process the initiator host issues a command to a virtual target which is located in the switch . The virtual target known to the initiator has a different WWN than the actual target storage device . The switch then applies storage application logic to perform mirroring. Thus the command is sent to the storage device and a copy of the command is sent to the storage device . In addition to mirroring many data services are available in a fabric including for example migration snapshot replication and journaling. These translation services are discussed more fully in U.S. patent application Ser. No. 10 695 408 the contents of which are incorporated by reference. However the proper execution of such services requires that each device knows all available devices on the SAN. However adding removing or changing a device on a fabric requires the host and the target in a fabric to perform a fabric login and re learn all devices i.e. the PIDs and WWNs of the devices on the fabric.

For example when a device e.g. host is connected to the Fibre Channel switch it performs an initialization process known as a fabric login. In this process the switch registers the WWN of the device with the name server which generates a unique PID for the device. As mentioned above the PID describes the location of the device in relation to the switch in the SAN with information such as the switch and switch port that the device is connected to. Initialized devices that are initiators attempt to log in to other devices on the SAN to find out what they are and to create proper connections to the devices. This learning is performed by querying the name server in the switch to receive the PID and WWN of each device. Further when a device connects to or disconnects from a fabric the switch sends registered state change notifications RSCNs to the devices that have registered to receive them.

Conventionally inserting a virtual target with its own WWN between an existing host and a physical target requires the host to break the existing connection and re scan to find the new virtual target with its WWN. While this re scanning is troublesome and desirable to be removed a larger problem is that both fabric zoning and access control lists ACLs maintained by various entities also have to be changed. Fabric zoning is complicated and being required to change it to allow use of the virtual target is burdensome. Changing the ACLs is even more burdensome as it requires administrator operations on each of the affected devices. Thus insertion of a virtual target is a burdensome task and alleviating the effect is desirable. Although advances in Fibre Channel standards have helped make these processes less disruptive to a SAN network designers are continuously seeking new ways to increase storage space processing capabilities and data transmission rates while decreasing downtime periods on a fabric .

One or more embodiments according to the invention relate to frame redirection which includes methods to intercept and re route traffic between an initiator and a target. If frame redirection is used for a particular frame an initiator of the frame issues the frame to the target. However the frame is received by a virtual target in a redirection switch rather than the intended target. This is accomplished by allowing the redirection switch to present the virtual target to the initiator as if it were the actual target i.e. rather than using the port identifier of the actual target the redirection switch presents the port identifier of the virtual target to the initiator and use the WWN of the actual target. From the perspective of the initiator the target resides on the redirection switch its address simply having been changed which is a common occurrence in a Fibre Channel fabric. Although the initiator believes it is sending a frame directly to the intended target it is actually sending the frame to a virtual target in the redirection switch.

From the redirection switch the frame is sent to the actual target by allowing the redirection switch to use the identity of the initiator. In other words the redirection switch presents the WWN of the initiator to the target. Thus the target receives the frame believing that the frame originated at the initiator though again at a different address. Such redirection prevents the need to re scan for devices to change access control lists or to restructure zoning in a fabric for example when a device is changed in the fabric.

Reference will now be made in detail to several embodiments of the invention examples of which are illustrated in the accompanying drawings. Reference in the specification to one embodiment or to an embodiment means that a particular feature structure or characteristic described in connection with the embodiments is included in at least one embodiment of the invention. The appearances of the phrase in one embodiment in various places in the specification are not necessarily all referring to the same embodiment. Wherever practicable the same reference numbers will be used throughout the drawings to refer to the same or like parts.

As mentioned briefly above frame redirection occurs by using a redirection switch to re route a frame intended to pass from an initiator to a target. Instead of allowing the frame to pass directly to the target the redirection switch intercepts the frame by creating a virtual target that uses the WWN of the actual target. The virtual target receives the frame from the initiator and sends the frame to the actual target with a virtual initiator which uses the WWN of the actual initiator. In contrast to virtualization where an initiator issues a frame to a virtual target that uses its own WWN in a switch frame redirection allows an initiator to issue a frame to the actual target. Frame redirection allows for data services including for example mirroring migration snapshot replication and journaling etc. without having to worry about when devices change e.g. are replaced on a fabric. These data services referred to as translation operations are discussed more fully for example in U.S. patent application Ser. No. 10 695 408 the contents of which are incorporated by reference.

When a host uses frame redirection to send a frame to a target the host sends the frame to a virtual target in the redirection switch believing that the virtual target in the redirection switch is actually the target e.g. storage device due to the use of the WWN of the actual target. Thus the frame is passed from the HBA to the port . When the redirection switch has processed the frame it is passed from a port e.g. to the intended or actual target e.g. storage device . Thus as seen in the ports of the redirection switch link initiators e.g. host devices to targets e.g. storage devices .

In the redirection processor a received frame is passed from a port to a virtual target . From the virtual target a volume manager provides mappings from logic units to the appropriate physical target e.g. . The frame is passed to the virtual initiator which sends the frame to the appropriate physical target e.g. via the corresponding port e.g. . To the physical target the frame appears to have been sent by the host even though it was sent by the virtual initiator .

The switch ASIC has four basic modules port groups a frame data storage system a control subsystem and a system interface . The port groups perform the lowest level of packet transmission and reception. Generally frames are received from a media interface and provided to the frame data storage system . Further frames are received from the frame data storage system and provided to the media interface for transmission out a port . The frame data storage system includes a set of transmit receive FIFOs which interface with the port groups and a frame memory which stores the received frames and frames to be transmitted. The frame data storage system provides initial portions of each frame typically the frame header and a payload header for FCP frames to the control subsystem . The control subsystem has translate router filter and queuing blocks. The translate block examines the frame header and performs any necessary address translations such as those which will happen when a frame is redirected as described herein. There can be various embodiments of the translation block with examples of translation operation provided in U.S. patent application Ser. No. 10 695 408 and U.S. Pat. No. 7 120 728 both of which were referenced above. Those examples also provide examples of the control data path splitting of operations. The router block examines the frame header and selects the desired output port for the frame. The filter block examines the frame header and the payload header in some cases to determine if the frame should be transmitted. In the preferred embodiment hard zoning is accomplished using the filter block . The queuing block schedules the frames for transmission based on various factors including quality of service priority and the like.

This is one embodiment for performing the required frame translations and routing to accomplish frame redirection as described herein. Other embodiments and different architectures can be used.

As shown in redirection APIs include various APIs to perform tasks related to frame redirection in a fabric. More specifically the redirection APIs include frame redirect APIs zone service group APIs and Fibre Channel identification FCID APIs . These APIs are used by management functions either internal or external to the switch to manage the redirection operations. The frame redirect APIs enable the switch to configure the frame redirect feature. These APIs are configured to associate and disassociate a physical target and virtual target to activate a virtual target in frame redirect mode and also to expose the virtual target. Further the redirect APIs are configured to associate and disassociate a physical target e.g. to and from a virtual initiator e.g. .

The zone service group APIs are used to perform functions related to setting and clearing redirect group zones explained in detail below. These APIs are configured to add or remove a redirect group zone. More specifically the zone service group APIs commit added redirect group zones commit defined redirect group zones to the name server and query to the name server for redirect group zones.

The FCID APIs are used to set FCIDs to the virtual target and the virtual initiator due to the use of the initiator s WWN by the virtual initiator . These APIs allow a user to set an FCID index for the virtual initiator or the virtual target at a data path controller for which the index is to be used. These indexes are used during fabric login FLOGI operations. In general the indexes are set for all of the virtual entities or for none of the virtual entities as setting indexes for only some of the virtual entities may lead to failures when attempting to register a virtual initiator or a virtual target.

In order to perform frame redirection special redirect group zones are created to group the logical entities that need to communicate with each other. Such a redirect group zone includes identification for an initiator and a target on the fabric as well as a virtual initiator and a virtual target on the redirection switch. It is important to note that a redirect group zone is not a zone in the typical sense of a SAN rather a redirect group zone changes the manner in which an initiator e.g. host and a target e.g. storage device communicate. Once a redirect group zone is defined traffic from an initiator to a target will be routed through the redirection switch having the virtual initiator and the virtual target corresponding to the redirect group zone.

Two separate redirection policies may be created referred to as restartable and non restartable policies. A restartable policy allows initiator and target traffic to pass freely regardless of whether the redirection switch is operating. Such a policy is useful when downtime is not acceptable between an initiator and a target e.g. when data migration is used . In contrast a non restartable policy requires both the virtual initiator and the virtual target to be operating for traffic to pass between the initiator and the target. Such a policy is useful when an initiator should not communicate with a target without the information first passing through the redirection switch e.g. when data must be encrypted or decrypted . Once created the redirect group zones created having these policies are propagated to other switches in a fabric and are enforced by each name server in each switch.

Alternatively a graphical user interface GUI tool could be used to specify the relevant devices. The various physical initiators and targets can be displayed. The user can then select the desired initiator which provides the initiator and virtual initiator WWNs and the initiator PID with the virtual initiator PID being assigned so that frames are directed to the switch the target whose frames are to be redirected which provides the target and virtual target WWNs the virtual target PID being assigned so that frames are directed to the switch and the target which is the destination of the redirected frames which provides the target PID. From these selected devices the redirect group is created and provided to the name server. Operation would then proceed at step .

Once a redirect group zone is created and committed frame redirection may be used. shows a flow chart illustrating how frame redirection querying occurs according to an embodiment of the invention. This occurs for example when an initiator attempts to establish a session with a target e.g. when an initiator attempts to send a Fibre Channel frame to a target on a fabric . When a redirection switch determines that a virtual device in a particular redirection group i.e. a virtual target or a virtual initiator has issued a query Step the name server e.g. name server returns the true WWNs and port identifiers of the initiator or the target in that redirection group to the device Step .

Otherwise as long as frame redirection is in effect Step the output from the name server is dependent on whether an initiator or a target issues a query. The name server stores the WWNs of redirection groups. When a query is received by an initiator Step in a redirection group the initiator attempts to obtain the port identifier for the target using the WWN of the target. Using frame redirection the name server returns the WWN of the target with the port identifier of the virtual target Step . In this manner when a frame is sent from an initiator to a target the initiator will use the port identifier of the virtual target and the redirection frame will be redirected to the virtual target. Similarly when a query is received by a target Step the name server returns the WWN of the initiator with the port identifier of the virtual initiator Step . In other words when the name server returns a WWN to a host that is the WWN for the virtual target the WWN is the same as a WWN for the target. Similarly when the name server returns a WWN to a target the WWN for the virtual initiator is the same as a WWN for the host.

Frame redirection may be best understood by way of describing the path of an example frame on which a translation operation is performed with reference to . Translation operations include for example mirroring migration snapshot replication and journaling. These operations are discussed more fully for example in U.S. patent application Ser. No. 10 695 408 the contents of which are incorporated by reference. In this example data mirroring will be used.

In an example frame is sent by the host to pass from the host to the storage device . In this process the initiator host issues a command to the physical target which is storage device . Before the frame is sent the host queries the switch to obtain the WWN of the target storage device . The name server provides the initiator with the WWN of the target and the port identifier of the virtual target . Thus when the host sends the frame the frame is redirected to the virtual target in the switch which applies any necessary storage application logic. In other words data mirroring is used to back up the data on the storage device . The frame is passed from the virtual target to the virtual initiator and a redirected frame is created. The virtual initiator sends the redirected frame to the storage device from the switch using the initiator identity i.e. that of the host but with the virtual initiator port identifier. A copy of the redirected frame is also sent to the storage device using the initiator identity as just described. Similar operations but with exchanged devices are performed when a target queries the switch for the WWN and port identifier of an initiator.

The above description assumes that the redirection is already initialized before the host or target query the switch. If the host and target are already connected the administrator develops the redirection and its related virtual targets virtual initiators and redirect zones as described above. In the final step effectively when the redirection is made active the switch sends RSCNs effectively from the host and the target causing each device to reacquire the port identifiers of the other devices. The switch captures these requests as described above and the virtual target and virtual initiator are effectively inserted into a path between the host and target without any additional administrator actions as no main zones need to be changed no ACLs need to be recreated and no devices need to be disconnected reconnected or otherwise forced to re scan the fabric. In summary an online insertion can be performed in a simple and efficient manner.

Advantages of the invention include one or more of the following. One or more embodiments according to the invention enable storage application services to be enabled without requiring any host or target reconfiguration.

While the present invention has been described with respect to a limited number of embodiments those skilled in the art will appreciate numerous modifications and variations therefrom. It is intended that the appended claims cover all such modifications and variations as fall within the true spirit and scope of this present invention.

