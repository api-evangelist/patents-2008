---

title: Subscriber management and accounting using event detection in a wireless device
abstract: A system and method performs real-time subscriber management and accounting for a wireless device by detecting predetermined events within the wireless device and communicating information pertaining to such events from the wireless device to a real-time subscriber management platform in association with each communication session. The information received by the real-time subscriber management platform is used to control the behavior of the wireless device and/or to update accounting information pertaining to the subscriber.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08095127&OS=08095127&RS=08095127
owner: Xius Holding Corp.
number: 08095127
owner_city: Woburn
owner_country: US
publication_date: 20080711
---
This application is a continuation of U.S. patent application Ser. No. 10 917 259 filed Aug. 12 2004 and titled SUBSCRIBER MANAGEMENT AND ACCOUNTING USING EVENT DETECTION IN A WIRELESS DEVICE which claims the benefit under 35 U.S.C. 119 e of Provisional Patent Application No. 60 495 642 filed Aug. 15 2003 and titled EXTENDED INTELLIGENT NETWORK CALL CONTROL USING TRIGGERS RESIDENT IN A WIRELESS DEVICE WITHIN A WIRELESS COMMUNICATION NETWORK.

The present invention pertains to a system and method for controlling the operation of a wireless device in a communication network and more specifically to a system and method that controls the operation of the wireless device using controls disposed within the wireless device that are cooperative with a subscriber management platform or server.

Wireless communication networks have been widely deployed for over a decade. Over time telecommunications networks have evolved from switch based networks in which switches included both data and control plane capability to networks known as Intelligent Networks IN in which the control plane is separated from the data plane. In an IN the intelligence and control functions are removed from the switches and reside in SS7 control elements such as Service Switching Points Signal Transfer Points and Service Control Points as known in the art.

In conventional wireless communication networks a call detail record is generated at the serving switch at the conclusion of each call. The call detail records are forwarded to a central database before being communicated to the serving or billing carrier or accounting service. As a consequence delays in performing accounting are introduced.

In accordance with the present invention a system and method for controlling the behavior of a wireless device within a wireless communications network is disclosed. In one embodiment of the presently disclosed system a subscriber identity module SIM or other removable processor memory module is disposed in a handset housing and is electrically coupled to the handset logic. The SIM includes an application program SIMapp that interacts with and allows a real time subscriber management RTSM platform to control the operation of the service. The RTSM platform comprises one or more servers databases and control software that are employed for wireless service accounting and control functions. The RTSM platform has connectivity to a wireless operator s SS7 network via a service control point.

More specifically the SIMapp application executing on a processor within the SIM performs functions in conjunction with the RTSM platform that permit real time subscriber management and accounting in a way that minimizes implementation and or integration requirements on the wireless operator s existing infrastructure.

The SIM is communicably coupled to the handset logic of the mobile equipment ME via a SIM Application Toolkit Application Programming Interface SAT API which is typically supplied by the supplier of the mobile equipment. The SIMapp application is therefore capable of communicating with the handset logic to control the handset obtain notifications of call events and to issue commands to the handset logic through the SAT API to initiate wireless communications between the wireless device and the RTSM platform via a data messaging protocol such as a data bearer channel communication protocol. Conversely information sent from the RTSM platform is received by the handset logic and routed to the SIMapp application via the SAT API. Based on the above described communication among the SIMapp the handset logic and the RTSM platform the subscriber s wireless communication experience can be controlled. This control is achieved without requiring Intelligent Network triggers or loop back trunks.

Other features aspects and advantages of the presently disclosed apparatus and method will be apparent to those of ordinary skill in the art from the Detailed Description of the Invention that follows.

U.S. Provisional Patent Application No. 60 495 642 titled Extended Intelligent Network Call Control Using Triggers Resident in a Wireless Device Within a Wireless Communication Network filed Aug. 15 2003 U.S. Provisional Patent Application No. 60 449 907 titled Method and System for Exercising Supervisory Control Over Wireless Phone Usage filed Feb. 25 2003 and U.S. patent application Ser. No. 10 784 611 titled Method and System for Providing Supervisory Control for Wireless Phone Usage filed Feb. 23 2004 are hereby incorporated by reference herein.

In accordance with the present invention a method and apparatus for controlling the behavior of a wireless device and performing real time subscriber management and accounting functions is disclosed. Predetermined events are detected within the wireless device and specific information pertaining to such events is stored. The stored information or information derived from the stored information is communicated to the RTSM platform either in response to the occurrence of the event that caused the information to be stored or alternatively at the end of a call. The information communicated to the RTSM platform is communicated via a data message sent over for example a data bearer communication channel. In the illustrated embodiment the information communicated includes counter values and associated information that is employed by the RTSM platform to determine the time date and duration of a call. It should be understood that stored information need not be conveyed by the data message in all embodiments and that in some systems information indicating that a predetermined event has occurred may be conveyed to the RTSM platform via the data message. The information pertaining to calls and or events detected by the SIMapp on the wireless device are communicated to the RTSM platform and employed by the RTSM platform for call accounting and subscriber management functions as subsequently discussed in greater detail. For example the SIMapp sends a Service Start Invoke message to the RTSM platform when a service that requires pre authorization and that involves the wireless device is initiated. The RTSM platform maintains call tariff data available balance amounts for prepaid subscriber accounts and information defining how calls involving specific subscribers are to be accounted for and processed.

Referring to the presently disclosed system includes a wireless device in communication with the RTSM platform via a communications network . In the illustrated embodiment the wireless device includes handset logic a subscriber identity module SIM and an interface between the SIM and the handset logic . The SIM is removably inserted into the wireless device housing. The SIM includes a processor and a memory . Other removable memory processor modules such as USIMs or R UIMs are also acceptable although for simplicity an embodiment that utilizes a SIM will be described. The processor within the SIM executes an application program referred to herein as the SIMapp that is stored within the memory of the SIM .

The RTSM platform comprises one or more servers that each include at least one processor and at least one memory. The RTSM platform further includes a database DB . The RTSM platform is operative as a real time transaction processing system that interacts with the SIMapp to perform call accounting and subscriber management functions as subsequently discussed in greater detail.

The SIM includes a memory and a SIM processor that executes the SIM application SIMapp resident in the SIM memory . The memory includes a re writable portion a non volatile RAM portion and additionally may include volatile RAM.

A handset processor is operative to execute software code and or firmware stored within a handset memory . The handset logic further includes a plurality of timers identified as timers and which are used to perform timing functions used by the SIMapp . In one embodiment of the presently disclosed system the timers and may be loaded and read under the command of the SIMapp .

A radio frequency RF modem is coupled between the handset logic and an antenna . The RF modem receives RF signals and converts the received RF signals to digital signals that are conveyed to the handset logic . Additionally the RF modem converts digital signals to RF signals that are transmitted from the handset logic via the antenna .

The interface between the SIM and the handset logic includes an Application Programming Interface known as the SIM Application Toolkit Application Programming Interface SAT API which is typically supplied by the supplier of the mobile equipment. The SAT API enables the SIMapp to command the handset logic to initiate communications with the RTSM platform and to load and read the timers and . Additionally the SAT API allows information that is sent from the RTSM platform and received by the handset logic to be passed via the SAT API to the SIMapp . Based on these communications the SIMapp in cooperation with the RTSM platform is able to control the behavior of the wireless device .

The wireless device communicates with a wireless operator s network which includes a Base Station Controller BSC a Mobile Switching Center MSC and a Home Location Register HLR . These network elements are communicably coupled by the wireless operator s network or control channel such as an SS7 telecommunications network. The RTSM platform is coupled to the operator s control channel via a Service Control Point SCP where the control channel comprises an SS7 network.

The SIMapp within the wireless device initiates most of the communications between the SIMapp and the RTSM platform . Communication between the SIMapp and the RTSM platform occurs through the exchange of data messages.

By way of example and not limitation communication between the SIMapp and the RTSM platform may be via the Short Messaging Service SMS using the Short Message Peer to peer Protocol SMPP SMS via Mobile Application Part MAP Unstructured Supplemental Services Data USSD via Transaction Capability User Part TCAP or any other suitable over the air data messaging protocol. Exemplary protocols are discussed further below.

In this scenario the SIMapp uses the SEND SS proactive command from the SAT API to command the handset logic to generate an SMS SUBMIT into the serving network. The SMS message is routed to the appropriate serving short message service center SMSC and is routed via a standard protocol for SMS messaging known as Simple Mail Point to Point SMPP eventually arriving at an SMPP Gateway not shown in communication with the RTSM platform . The SMPP Gateway in communication with the RTSM platform communicates with the SDP of the RTSM platform see which generates a response. The response is forwarded via SMPP and eventually arrives at the appropriate serving SMSC. The SMS DELIVER is received by the handset logic and routed to the SIMapp completing the transaction. This scenario uses the wireless network s existing SMS infrastructure. SMS Via MAP In this scenario the SMS SUBMIT bypasses the operator s existing SMS infrastructure and is sent directly over the SS7 network to the RTSM platform . The RTSM platform formats a response and sends the appropriate MAP transaction so the serving MSC delivers the response as an SMS DELIVER to the wireless device . The RTSM platform performs a subset of the functions of an SMSC for both the requests and responses reducing both the network latency and operational cost. For example the SMSC the within the RTSM platform queries an HLR to determine the servicing MSC so the MAP transaction can be correctly addressed. However the SMSC need not implement a store and forward capability. The carrier assigns the RTSM platform a E.164 number so SMS messages can be addressed to the platform. The carrier provisions this number into the SIM so the SIMapp can address SMS messages to the RTSM platform . In addition the carrier assigns an SMSC address to the SMSC within the RTSM platform . The messaging between the RTSM platform and the SIMapp may be via one or more intermediate SMSCs within the network if the network latency and operational concerns are not significant. USSD Via MAP

USSD provides an alternative to SMS for messaging between the SIMapp and the RTSM platform . USSD is lightweight in nature making it a desirable messaging protocol where supported. In one embodiment USSD is employed to communicate from the SIMapp to the RTSM platform and SMS is employed for the reverse path.

In this embodiment SIMapp control messages are transported to and from the RTSM platform via a GPRS data session initiated by the SIMapp .

Communication between the SIMapp and the RTSM platform proceeds using a Request Response model. illustrates the basic communication technique in the circumstance in which data messaging is performed using an SMS bearer channel communication service. Referring to when communication with the RTSM platform is required the SIMapp instructs the handset logic via the SAT API to generate an SMS SUBMIT message containing the message data. The MAP messaging for SMS is directed to the RTSM platform by the MSC. SMS messages are addressed to phone numbers. The RTSM is assigned a E.164 number to facilitate addressing SMS messages to the RTSM. SMS messages that are destined to the SIMapp and are delivered to the wireless device are passed to the SIMapp rather than being displayed on the screen of the wireless device in a well known manner. MAP Service Logic resident on the SCP constitutes the RTSM SIMapp Interface for communicating with the SIM . The RTSM SIMapp Interface initiates an SMS DELIVER message containing the response data and addresses it so that it is returned to the SIMapp via the MSC .

As previously noted the SIMapp and RTSM communicate using a request response model. Each request is processed by the receiving system and a response is generated and returned to the initiator of the request. Requests initiated by the SIMapp correspond to events that occur on the handset and generally correspond to the concept of triggers in an intelligent network IN system. Specific events may be detected as predetermined signals or messages within the wireless device. The RTSM platform returns responses to these triggered events containing one or more directives that instruct the SIMapp as to what action should be performed. The RTSM platform can initiate the transmission of directives to the SIMapp independent of the detection of call related events on the wireless device without first receiving a request from the SIMapp .

In the event that the profile for the subscriber indicates that a pre call authorization is to be performed for Mobile Originated MO attempts the RTSM Registration Response includes an indication in a status element to this effect. The RTSM Registration Response also includes a text element that instructs the SIMapp to display account information on the wireless device display. This information can include the subscriber s remaining balance and an indication of when those funds expire. As a matter of policy some carriers limit the length of time unused funds remain in subscribers accounts. After such time the funds are transferred to the carrier i.e. the funds expire. An exemplary indication of such a display is provided below.

When the SIMapp detects certain predetermined events the SIMapp sends a message to the RTSM platform indicating that the respective event has occurred. Upon detection of other specified events the SIMapp controls the wireless device to perform predetermined functions. For example upon detection of a Call Control event in the form of the initiation of a mobile originated call the SIMapp forwards a data message to the RTSM platform that contains data about the event e.g. a dialed number. The response from the RTSM platform instructs the SIMapp how to proceed and may contain context data to be stored and returned with the response to another related event. For example a Service Start Response may contain context data that is later returned with an associated Service End Invoke. The response may also include other instructions indicating how services are to be provided. The instructions contained in the response may set a maximum duration for the service instance may allow the service instance or may disallow the service instance. Additionally the response from the RTSM platform may specify warning tones or messages to be provided under specific circumstances.

More specifically when the subscriber attempts to place a mobile originated MO call or the SIMapp detects an incoming mobile terminated MT call the SIMapp sends a Service Start Invoke Message to the RTSM platform that contains the MSISDN of the wireless device the dialed number and in one embodiment may include information indicative of the location of the wireless device . Typically phone location information is conveyed to the RTSM upon power up of the phone or upon a change in location of the wireless device such as a change in cell site cell site sector or carrier for example as the wireless device roams. The RTSM platform determines if the subscriber can make or receive the call and returns a Service Start Response Message that indicates that the placement of the MO or MT call is to be allowed or disallowed.

In one embodiment the SIMapp delays completion of the call until it receives the Service Start Response Message. In this case the SIMapp either allows or disallows the call based on the contents of the Service Start Response Message.

In another embodiment the SIMapp does not delay completion of the call. In this case if a MT call is disallowed by the RTSM the SIMapp may receive the Service Start Response Message after by as much as several seconds after the call has been completed. If so the SIMapp ends the call upon receiving the Service Start Response Message.

In this embodiment the SIMapp ends MO calls immediately generally before the calls are completed and then waits for the service Start Response Messages. If a response message allows a MO call the SIMapp re initiates the call in a manner that is transparent to the subscriber. The relatively short delay between the user dialing the digits of the called number and the re initiation of the call by the SIMapp is generally not noticeable to the subscriber.

On the other hand if the Service Start Response Message indicates the MO call is disallowed the SIMapp does not re initiate the call. Optionally the SIMapp issues an instruction to cause a tone or message to be played or displayed to the subscriber.

When the call ends the SIMapp detects this event and sends a Service End Invoke Message to the RTSM platform . The RTSM platform rates the call using information contained in the Service End Invoke Message and call tariff data maintained at the RTSM platform and debits the subscriber s account which is also maintained at the RTSM platform . The RTSM platform then returns a Service End Response Message to the SIMapp . The Service End Response Message includes text to be displayed on the subscriber s handset that indicates the available funds remaining in the subscriber s account and an indication of when those funds expire as discussed above.

The Configuration Update Request from the RTSM platform to the SIMapp can contain directives that the SIMapp is instructed to perform. The response from the SIMapp contains status information.

The selected MSC next queries the HLR via a query message . In the instant case it is assumed that the subscriber is configured in the HLR as a full featured subscriber. A full featured subscriber account can be provisioned as for example postpaid postpaid with a spending limit or any other suitable type. The HLR returns the relevant subscriber status to the MSC . For example in a GSM system the HLR indicates whether service is or is not to be provided to the wireless device. The MSC then communicates a registration message to the handset logic to complete the registration of the wireless device with the MSC so that the wireless device can communicate over the network with the MSC .

The SIMapp can be configured in either of two states dormant or active and the state of the SIMapp can be changed by the carrier. In the dormant state the SIMapp does not receive notifications from the handset logic and plays no role in controlling calls to or from the wireless device . In the dormant state the SIMapp does not interact with the RTSM platform when calls are placed to or from the mobile device. Instead the wireless device acts as a normal full featured wireless device.

In the active state the SIMapp receives notifications of call events from the handset logic . The SIMapp can be further configured to react or not to react to the notifications from the handset logic . If the SIMapp is configured not to react to these notifications the SIMapp registers with the RTSM platform as described below but otherwise ignores the notifications from the handset logic . On the other hand if the if the SIMapp is configured to react to these notifications the SIMapp operates as described herein. The RTSM platform can send messages to the SIMapp to configure the SIMapp to either ignore or react to the notifications from the handset logic .

Thus no changes are needed to the HLR to support full featured wireless devices and devices that are controlled by the RTSM platform . Wireless devices that are controlled by the RTSM platform can be provisioned in the HLR as though they were full featured devices. In addition a given wireless device can be changed from an unrestricted for example postpaid or hybrid spending limits device to a restricted for example prepaid device or vice versa by changing the state of the SIMapp but without requiring changes in the HLR . Furthermore the same type of hardware i.e. wireless devices with SIMapp can be dispensed to both full featured subscribers and to subscribers whose wireless devices are to be controlled by the RTSM platform .

Assuming the SIMapp is configured in an active state following registration of the wireless device with the MSC the SIMapp initiates the registration of the wireless device with the RTSM platform by forwarding an RTSM Registration Invoke Message . The Registration Invoke Message includes location information that indicates the location of the wireless device such as the serving cell site ID and the version and revision level of the SIMapp code. The wireless device acquires location information through the wireless network as is well known. In one embodiment this location information includes a country code an area code and a cell site ID. Other embodiments include information sufficient to enable the RTSM platform to properly rate calls.

In response to receipt of the Registration Invoke Message the RTSM SIMapp Interface communicates with the RTSM platform via a message to store the information contained within the Registration Invoke Message in the RTSM DB . The RTSM platform may return to the RTSM SIMapp Interface in a message an Internal Timer Value to be communicated to the SIMapp . The Internal Timer Value specifies a time to a known point in the future and is subsequently discussed in greater detail. The Internal Timer Value can be stored in the RTSM DB calculated on the fly or hard coded in the RTSM platform logic.

The RTSM SIMapp Interface then forwards an RTSM Registration Response Message to the SIMapp via the SCP . The RTSM Registration Response Message includes a tag associated with the message being responded to that identifies the response and the Internal Timer Value if such is provided.

When the SIMapp receives the RTSM Registration Response Message from the RTSM SIMapp Interface if the message contains an Internal Timer Value the SIMapp loads the Internal Timer Value into countdown timer and starts the countdown timer . The timer is illustrated as a countdown timer although it is recognized that other forms of timers may be substituted such as count up timers in which the counter is initialized to 0 and the current counter value is compared to the Internal Timer Value to determine if the counter has expired.

If the Registration Response Message does not include an Internal Timer Value no timer values are sent to the RTSM platform along with messages the SIMapp sends to indicate call initiation etc. In this case the RTSM platform can use an internal timer to time calls. Alternatively for services such as wireless data browsing call accounting can be performed based on the number of such requests rather than on the durations of the requests.

The RTSM SIMapp Interface issues a query message to the RTSM DB A see . If adequate funds are present in the applicable prepaid account the RTSM DB communicates such information to the RTSM SIMapp Interface in a message and reserves a specified number of minutes as allotted time. This process is referred to as balance reservation. The message to the RTSM SIMapp Interface includes an indication of the call authorization and the minute reservation allotted time .

The RTSM SIMapp Interface forwards a Service Start Response Message to the SIMapp that includes the authorization security information and the allotted time. In response in one embodiment the SIMapp allows the dialed digits to be transmitted by the handset logic to the MSC see as depicted at message and the SIMapp starts an allotted time timer . In another embodiment the dialed digits are transmitted by the handset logic but the SIMapp subsequently ends the call typically before it is completed . Later if the SIMapp receives approval for the call from the RTSM platform the SIMapp re initiates the call in a manner that is transparent to the user. The allotted time timer provides an indication when the allotted time timer equals the reserved number of minutes received in the Service Start Response Message .

Following the transmission of the dialed digits to the MSC as depicted by event if the call is a MO call the call involving the wireless device is connected to the called party to permit communication between the subscriber and the called party. The SIMapp detects the connection of the call as a Call Connect Event. In response to the detection of the Call Connect Event the SIMapp reads the internal countdown timer and stores the value as one component of T.

In the event the allotted time timer expires indicating that the allotted time has been utilized the SIMapp sends another Service Start Invoke Message to the RTSM SIMapp Interface to request an additional reservation of time. The RTSM SIMapp Interface queries the RTSM DB as illustrated by message ascertains whether the account balance is adequate and if adequate returns an authorization and minute reservation for communication to the SIMapp . The RTSM SIMapp Interface sends a Service Start Response Message to the SIMapp that includes the authorization and new allotted time for storage in the SIMapp allotted time timer . The time reservation is stored in the allotted time timer and the allotted time timer is restarted.

When the call is disconnected the SIMapp detects this event as a Call Disconnect Event as illustrated by event . In response to the detection of the Call Disconnect Event by the SIMapp the SIMapp reads the value of the internal countdown timer and stores the value as a component of T. The SIMapp then generates a Service End Invoke Message that includes three data sets referred to herein as T T and T and the context information that is employed to identify the call.

The data sets T T and T each contain a Timer Value Identifier that identifies the data set a counter value and a rollover count. The timer identifier in one embodiment is the number of the data set i.e. 1 2 or 3. The counter value is an integer having a value greater than 0 that is read from the countdown timer . The counter value represents a duration in seconds between the occurrence of the respective event and the end of a pre specified period. The rollover count is an integer value greater than or equal to 0. The rollover count indicates if the countdown timer has expired since the wireless device last registered with the RTSM platform . For example assume the Internal Timer Value conveyed from the RTSM platform is 10000 seconds. The Internal Timer Value is loaded into the countdown timer and the countdown timer is started. Each time the countdown timer reaches 0 the countdown timer is reset to 10000 and the rollover count value is incremented.

The Service End Invoke Message is then communicated to the RTSM SIMapp Interface for use by the RTSM platform in performing call rating subscriber management and call accounting functions.

More specifically the difference between the counter values in T and T may be employed by the RTSM platform to determine the Send to End time should accounting be performed on this basis. Alternatively the RTSM platform may ascertain the difference between the values T and T in the event call accounting is to be performed based on the duration between the Call Connect Event and the Call Disconnect Event.

It should be recognized that instead of T T and T in the Service End Invoke Message the SIMapp could alternatively communicate the duration between the appropriate starting point for call accounting Call Control Event or Call Connect Event and the Call Disconnect Event and forward the calculated duration to the RTSM platform in the Service End Invoke Message . Additionally the SIMapp could forward the relevant timer values needed to calculate the duration value of interest for accounting in separate data messages in response to detection of the specific Call Control Call Connect and Call Disconnect Events.

In an alternative embodiment rather than receiving an Internal Timer Value from the RTSM platform the SIMapp uses real time values to identify times of call control call connect and call disconnect events. In such an embodiment the SIMapp ascertains the times of these events such as by querying a clock in the handset logic and the SIMapp conveys these times to the RTSM platform with or without storing these values within the T T and T records.

The RTSM SIMapp Interface obtains the call duration from the information contained in the Service End Invoke Message or as otherwise communicated to the RTSM platform and updates the RTSM DB A to reflect the time used as depicted by message . The RTSM platform performs an accounting in real time based on call rating data maintained at the RTSM platform and determines the balance remaining in the subscriber s account. The RTSM DB communicates the remaining subscriber balance to the RTSM SIMapp interface via message .

The RTSM SIMapp Interface forwards a Service End Response Message to the SIMapp that includes a text message that specifies the subscriber balance for display by the handset logic . The SIMapp displays the account balance on the handset logic display as depicted by event in .

The SIMapp controls the countdown timer that is resident in the wireless device for the purpose of determining time remaining to the end of a specified period. The countdown timer may be implemented within the handset logic and accessed via the SAT API interface or alternatively may be implemented as logic within the SIM . As events occur the value of the countdown timer is read by the SIMapp through the SAT API interface and the respective timer value is associated with the event. Periodically for example every 30 seconds the value of the countdown timer is recorded to a memory in case of a subsequent unexpected power loss.

The SIMapp can be configured to send messages to the RTSM platform at the end of each call. Alternatively it should be recognized that the SIMapp may be configured to send a message to the RTSM platform in response to the detection of any predetermined event or in association with the detection of a call. In the presently illustrated embodiment the information conveyed includes the three 3 timer values T T and T as discussed above. The T timer value is recorded by the SIMapp at the time of Call Control call initiation for a MO call page of handset for a MT call . The T timer value is recorded by the SIMapp at the time the call is connected for either a MO or a MT call. The T timer value is recorded at the time the call ends for either a MO or a MT call.

The SIMapp is capable of recovering correctly from an unexpected loss of power. This is sometimes referred to as a battery pull scenario because one possible way for this situation to occur is as a result of the physical removal of the battery from a wireless device during a call. If power is lost during a call and the SIMapp is configured to notify the RTSM platform when the call is completed the SIMapp sends call detail information to the RTSM platform the next time the wireless device powers up.

During the course of a call the SIMapp records the counter and rollover values for T T and T in non volatile memory. The SIMapp periodically updates the counter value and the rollover count value of T as the call continues. Updates are performed at an interval that provides reasonable granularity while not degrading handset performance. The counter and rollover values of T are set to the values of T when T is populated so that if a power loss occurs before T is updated for the first time the values of T and T are the same.

If on power up the SIMapp detects that a power loss scenario has occurred the SIMapp uses the saved values of T T and T to construct a Service End Invoke Message for the call that was in progress. The SIMapp subtracts one update interval from T before populating the Service End Invoke Message e.g. the SIMapp subtracts the amount of time within the update period 30 seconds in the present example from the last saved counter value of T. This essentially rounds T towards the next whole update interval. The operation of the SIMapp in the event of a power loss is discussed in further detail in connection with flow diagrams of .

In response to receipt of the Service End Invoke Message the RTSM platform calculates the call start time and the call duration. More specifically the RTSM SIMapp Interface maintains a timer value that corresponds to the time and date when the Internal Counter Value was conveyed to the SIMapp during the last succession registration. Based on this time and date information and the counter and rollover values stored in T T and T the RTSM SIMapp Interface calculates the start time of the call from either T or T as applicable and the duration of the call from T and T or T . These calculated values are used by the RTSM SIMapp Interface to rate the call as previously discussed.

As depicted in step the SIMapp stores the Internal Timer Value that was communicated to the SIMapp in the RTSM Registration Response Message or a constant Internal Timer Value if no such value is provided by the RTSM platform . In one embodiment the SIMapp stores a value of 86200 in the countdown timer which corresponds to the number of seconds in a 24 hour period. The actual constant chosen for storage in the countdown timer is a matter of design choice. The value stored in the countdown timer defines the point in the future at which the countdown timer will expire. The SIMapp also clears the rollover count values for T T and T and starts the countdown timer . The countdown timer runs continuously so that it can be sampled whenever the SIMapp needs to populate a timer value for a call event.

If in step it is determined that the Power Loss Flag was not set on power up the SIMapp stores the Internal Timer Value that was communicated to the SIMapp in the RTSM Registration Response Message or a constant Internal Timer value if no such value is provided by the RTSM platform and clears the rollover count values for T T and T and starts the countdown timer as depicted in step .

As illustrated in step the SIMapp determines whether the countdown timer has expired. If the countdown timer has expired the SIMapp increments the rollover count and resets the countdown timer .

The SIMapp determines whether a Power Loss event has occurred as illustrated in decision step . If the SIMapp detects the occurrence of a power loss during the call or before T T and T have been forwarded to the RTSM SIMapp Interface at the end of the call the SIMapp sets a Power Loss Flag within the non volatile memory as illustrated at step . If no power loss has occurred during the call as illustrated at decision step the SIMapp determines whether a Call Disconnect event has occurred. If no Call Disconnect event has occurred control passes to decision step to determine if n seconds n 30 seconds in the illustrative example have passed since the last update of T. If n seconds have passed T is updated by storing the current countdown counter value and the current rollover count in T as depicted in step . If n seconds have not passed since the last update of T control returns to decision step .

If in decision step a determination is made that a Call Disconnect event end of call has been detected the Timer ID 3 and the current counter and rollover values are stored in the T data set as illustrated in step . While a call is in progress the SIMapp may increase the frequency at which it updates the counter and rollover count values within the T data set to maintain more current and accurate counter values in the event of a power loss.

The SIMapp transmits to the RTSM SIMapp Interface a Service End Invoke Message that includes the T T and T data sets and the relevant context information that identifies the call session as shown in step .

The above described counter operation may be employed in GSM compliant phones and in cellular systems in which the SAT API between the SIM and the handset logic supports counter management. Additionally it should be recognized that the above described functionality of the SIM and SAT API may be embedded within the handset logic instead of in SIM .

Some wireless devices using other wireless protocols e.g. the iDEN protocol do not support SAT API commands for timer management. In such devices rather than sampling countdown and rollover values in response to detecting specified events the SIMapp directly calculates values that corresponds to the counter and rollover count values in response to the detection of the specified call events. The calculated values equal the period of time from the current time to a specified point in the future. The specified point in the future is communicated to the SIMapp by the RTSM platform as the Internal Timer Value in the RTSM Registration Response Message. The Internal Timer Value specifies the number of seconds to add to the time at which the RTSM Registration Response was received by the SIMapp . This defines the specified point in the future. If no Internal Timer Value is specified by the RTSM platform the specified point in the future is set by the SIMapp as 24 hours from the current time.

The SIMapp calculates the number of seconds from a Call Control event a Call Connect event and a Call Disconnect event to the specified point in the future during both MO and MT calls. Each calculated value is recorded in the T T or T data set as applicable. This information is transmitted to the RTSM platform in the Service End Invoke Message when the call disconnects in the manner previously discussed.

A rollover count is also generated by the SIMapp . In one embodiment each time the specified point in time is passed the SIMapp increments the rollover count so that the rollover count specifies the number of times the initially specified duration has occurred since the last registration. Thus every time the specified duration is passed it is extended by a predetermined period e.g. 24 hours and the rollover count is incremented by one. In an alternative embodiment the SIMapp checks if the rollover count needs to be incremented every time a timer value is calculated and recorded.

As an example of how T T and T would be populated consider the situation in which a the specified duration ends at midnight local time b the handset is powered on at 23 40 30 local time c a call is originated at 23 54 10 local time d the call is answered 10 seconds later and e the call lasts for 60 seconds. At the end of the call T T and T values are as illustrated in Table 5 below 

If the subscriber initiates another similar call at 23 59 50 T T and T values at the end of the cell as illustrated in Table 6 below 

The presently described system provides the capability of detecting predetermined events within the wireless device and communicating information pertaining to those events via a data message to a central server or subscriber management platform that provides a wide range of abilities including control of the behavior of the wireless device subscriber management and real time account management. The following section provides examples of the services that can be provided using the presently disclosed architecture. The list is illustrative only and is not intended to be exhaustive.

The SIMapp maintains configuration information that governs how specified events are to be processed. If a Mid Service Disconnect status is set and the allotted time timer expires before the call is otherwise disconnected the SIMapp disconnects the call.

When the Call Disconnect Event occurs the SIMapp performs the following tasks 1 obtain and record the current value of T 2 format and send to the RTSM platform a Service End Invoke Message containing the context information associated with the call the T T and T data sets and the Disconnect Reason Code. The Service End Response Message may contain a message to display on the handset logic e.g. the balance remaining.

It may be necessary for the SIMapp to monitor more than one call simultaneously as in the case of Call Waiting or Conference Calling. In these cases it may be necessary for the SIMapp to maintain separate sets of T T and T values along with context information for each call session.

As noted above if the balance in the RTSM platform is insufficient for a call the call is disallowed or disconnected. The RTSM platform can also selectively allow or disallow calls based on criteria other than a balance in an account associated with the user of the wireless device . In one embodiment the RTSM platform selectively allows or disallows calls based on a location of the wireless device . The DB stores information identifying geographic regions regions associated with various wireless carriers or other types of regions from or to which calls are allowed and or disallowed.

In another embodiment the RTSM platform selectively allows or disallows calls based on a list of permitted white listed and or forbidden blacklisted parties. These lists identify the parties by their respective telephone numbers caller ID names or other appropriate identification information.

In yet another embodiment the RTSM platform selectively allows or disallows calls based on a time of day of the calls. The DB stores information identifying time periods such as 9 a.m. to 5 p.m. weekends or holidays during which calls are allowed and or disallowed.

In another embodiment the RTSM platform selectively allows or disallows calls based on an amount of use of the wireless device within a predetermined control period. For example the RTSM platform can allow up to a cumulative total of 1000 minutes of calls in each calendar month.

In other embodiments the RTSM platform selectively allows or disallows calls based on a Boolean combination of two or more criteria such as those listed above or other criteria.

As a result of updates or changes to the SIMapp it may be desirable to alter the SIMapp programming from time to time. For this reason the network operator may update the SIMapp code image over the air OTA as it is known in the art.

The SIMapp is able to query the handset s capabilities and disable the handset in the event that it or the user s account does not meet some minimum criteria. This analysis is performed on power up and is useful in reducing the likelihood of fraudulent use. In the event the query results in a determination that the minimum established criteria are not met the handset logic is disabled. The disabling of the handset logic prevents it from being used to perform any MO or MT communications such as voice data bearer messaging e.g. SMS push to talk wireless data etc. Emergency numbers such as 911 and other specified numbers are always available.

The following configuration information defines how the SIMapp operates under pre specified conditions. This information can be changed during registration or via a Configuration Update message.

When the SIM is first powered on the SIMapp enters its most recently configured trust mode. The Trust mode is set to either a Trusting Mode or a Non Trusting Mode. In the Trusting Mode the SIMapp allows MO and MT calls even before a registration response is received from the RTSM platform . In the Non Trusting Mode the SIMapp does not allow MO or MT calls to proceed until a registration response is received from the RTSM platform that indicates that such calls are authorized. The default mode is the Non Trusting Mode. The RTSM platform may specify a trust mode in the RTSM Registration Response Message.

The SIMapp handles registration requests based on its currently configured registration mode. In one embodiment the SIMapp supports the Registration Modes discussed in Table 7 below.

The SIMapp handles Service Start Request Messages based on its currently configured Pre authorization Mode. The Pre authorization Modes are as indicated in Table 8 below.

The SIMapp handles Service End Invoke Messages based on the currently configured Service End Mode. The Service End Mode may be specified as indicated in Table 9 below.

As noted if a call is allowed the SIMapp may be provided with an allocated time for a call. In the event the allocated time is depleted the Allocation Depletion Mode specifies how the call is to be handled by the SIMapp . The Allocation Depletion Mode may be configured as set forth in Table 10 below 

If Pre Authorization is in effect for MO or MT calls and the Allocation Depletion action is Re Authorize then the Maximum Call Length indicates the maximum amount of time before the SIMapp is required to check with the RTSM platform again. When this time expires the SIMapp generates a new Service Start Invoke Message. This process can continue multiple times until the subscriber s balance is exhausted or the call ends. The Service Start Invoke Response can indicate that the subscriber has no more money in one of two ways 1 by returning a positive Maximum Call Duration but with an indicator that Re Authorization is no longer in effect essentially saying that s all the subscriber has left or 2 by returning a zero Maximum Call Duration essentially saying the subscriber had some earlier but it is all gone now . When either of these indications occur the action typically indicated is the disconnection of the call.

While the above described system has been described in terms of a call the presently disclosed system may be employed for detecting events pertaining to web browsing and other wireless data services and communicating information from a wireless device to a central server pertaining to such services for accounting and subscriber management functions. By way of example the SIMapp can detect browsing and optionally the amount of data retrieved by the browsing in packets bytes etc. Some communications including some web browsing do not have distinct start and end times. These communications can be treated as having only a start or only an end time. In response to the detection of the end of a browse the SIMapp may generate a data message to the RTSM SIM Interface that indicates that a browse was initiated or ended. Optionally the data message can include the number of bytes retrieved. The RTSM platform may utilize the number of such browses the number of bytes retrieved the type of data retrieved e.g. text music or video etc. for accounting based on wireless data rating information retained at the RTSM platform . Alternatively rather than informing the RTSM platform of each individual data transfer the SIMapp can seek pre authorization for a number of browses and or an amount of data that can be retrieved. The SIMapp can store the pre authorization amounts in the SIM. Then as the user browses the SIMapp can deduct appropriate counts from the appropriate stored pre authorization amount. If a stored pre authorization amount becomes depleted or reaches a low threshold the SIMapp can seek addition authorization from the RTSM platform .

Embodiments of the presently disclosed system enable the RTSM platform to receive real time information concerning calls and other communications for roaming and non roaming wireless devices. The RTSM platform can therefore collect this information and use it to perform call accounting. Alternatively or additionally the RTSM platform can use this information to generate and or store call detail records CDRs . The RTSM platform can forward these CDRs to another accounting and or billing system such as one operated by a carrier or a third party.

The above described system has been described in terms of calls wireless data services and other communications that are successfully completed. For example the RTSM platform can debit the subscriber s account for MO or MT calls that are answered but in one embodiment the RTSM platform does not debit the subscriber s account for calls that are busy intercepted or not answered. In another embodiment the RTSM platform can debit the subscriber s account for some or all communications whether they are successfully completed or not.

It should be appreciated that modifications to and variations of the above described methods and system may be made without departing from the inventive concepts disclosed herein. Accordingly the invention is not to be viewed as limited except by the scope and spirit of the appended claims.

