---

title: Method for implementing an internet protocol (IP) charging and rating middleware platform and gateway system
abstract: A method for Internet Protocol (IP) charging and rating gateway within a system having a proxy server for connection to an Authentication, Authorization, and Accounting (AAA) server, an access gateway, an IP classification engine for connection between a data network and the access gateway and a gateway controller connected to the proxy server and the IP classification engine, including the steps of receiving IP packets at the IP classification engine, the IP packets originating from the data network and destined for a subscriber device via the access gateway, classifying the IP packets according to the protocol of each of the packets at the IP classification engine and selectively instructing the IP classification engine to permit or deny the flow of IP packets between the data network and the access gateway at the gateway controller. Preferably, the proxy server is configured to emulate the access gateway and the AAA server.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07644158&OS=07644158&RS=07644158
owner: Redknee Inc.
number: 07644158
owner_city: 
owner_country: CA
publication_date: 20081103
---
This is a continuation of U.S. application Ser. No. 10 348 972 now U.S. Pat. No. 7 457 865 filed Jan. 23 2003 and is generally related to U.S. patent application Ser. No. 10 307 335 filed Dec. 2 2002 the entire contents of each of which is incorporated herein by reference.

With the evolution and migration of Internet and related informational services to mobile and or wireless handsets devices and so on telecommunications network operators are constantly seeking enhanced ways of rating for their respective data services. The prior art demonstrates considerable limitations weaknesses and infirmities in this regard.

Consider U.S. Patent Application 20010055291 by Schweitzer entitled System method and computer program product for charging for competitive IP over wireless service which details a means for charging Internet Protocol IP traffic but no substantial means for differentiating the traffic therein. Similarly European Patent Application EP 1026853 by Yamaguchi et al. entitled Charging Method for Information Communication Network teaches of art directed at merely counting the number of packets exchanged and nothing again of rating the different types of packets therein according to their pre established utility and or value.

Additionally art which does address the problem of classifying IP traffic remains insufficient or lacks the sophistication of that of present. As with U.S. Patent Application 20020152321 by Le et al. entitled Method and apparatus for classifying IP data makes reference to classifying said IP packets based only on IP header fields basically Layer two 2 of the OSI stack said stack has seven 7 layers . Our method disclosed goes well beyond Layer two 2 and involves classifying packets based on information obtained from Layer two 2 through to Layer seven 7 . For example Multi Media Service MMS classification performed by the disclosed invention depends on information obtained from layer six 6 and layer seven 7 . Our classification methodology incorporates correlation of data within the seven 7 layers to classify a packet. And similarly U.S. Patent Application 20020103925 by Sheth et al. entitled Generic programmable internet protocol classification technique for a broadband engine concentrates on IP classification specifically at the IPv4 header i.e. layer 2 3 . The art thereof is primarily directed at classification for more or less quality of service QoS reasons indeed the same can be said of the art identified former and providing differentiated services. Our art is directed primarily at classification for the purpose of packet and application level data type identification s .

Note also U.S. Patent Application 20020152321 October 2002 Le et al. 709 238 U.S. Patent Application 20020103925 August 2002 Sheth et al. 709 236 U.S. Patent Application 20010055291 December 2001 Schweitzer 370 337 Foreign Patent Document s 1026853 August 2000 EPO.

The present invention relates generally to wireless communications and gateway services and more specifically to a method for implementing an Internet Protocol IP charging and rating middleware platform and gateway system.

The Internet Protocol IP charging and rating middleware platform and gateway system disclosed herewith is intended to equip in this instance telecommunications network operators with the ability to rate and bill IP traffic such as File Transfer Protocol FTP and HyperText Transfer Protocol HTTP based upon any number of informational variables including volume quality of service source address destination address and or time of day. The art also accommodates differentiated billing based upon service type including Wireless Application Protocol WAP Multimedia Message Service MMS and other services which utilize the Internet Protocol IP as the transport protocol.

The implementation of the architecture preferentially resides at the access gateway point between the telecommunication provider s and or wireless operator s IP network as for instance GGSN Gateway GPRS General Packet Radio Service Support Node based or PDSN Packet Data Service Node based and the Internet Intranet. The IP charging and rating middleware platform and gateway system effectively allows for the inspection of IP traffic at definable points within the packet information.

For the purposes of simplicity and elucidation the architecture of the Internet Protocol IP charging and rating middleware platform and gateway system may be divided functionally among the IP Classification Engine the core of the art seeking protection of Letters Patent and the residual art the IP charging controllers.

Inherent to the technology and methodology of the IP Classification Engine IPCE remain the rating rules. Such rules are loaded into the IPCE whereupon a series of system level triggers are then armed to detect the occurrence of certain events as per the existing rating criteria. The arming of triggers and generation of event sets providing specific charging and or informational events form the functional foundation of the IPCE.

Triggers may be armed on a real time basis through the provisioning interface which link to a set of underlying Application Programming Interface s API s in this instance thereby providing application control for non limiting instantiations of protocol state destination URL or address Time of Day volume message content or type and text string among others. Indeed those skilled in the art shall recognize that a variety of object oriented application programming interfaces will serve the purpose of notification without affecting the intent and scope of the present invention. Triggers may also be armed on a protocol specific level including among others HTTP POP3 SMTP FTP MMS and WAP.

The IPCE also provides the logic for the blocking of data wherever said subscriber has insufficient funds.

The IP charging controllers in this instance represent much of the residual generic components of the Internet Protocol IP charging and rating middleware platform and gateway system as performing balance queries which decrements the usage values on each subscriber s temporary token account store after applying rating specific charges on the data flow information in real time and other intermediating functions.

With reference to wherever a mobile subscriber seeks to access the Internet and or related informational services via WAP Gateway NMSC or Multi Media Server respectively the GGSN sends via the RADIUS protocol an authorization request to the RADIUS Proxy Server of the Internet Protocol IP charging and rating middleware platform and gateway system . Technicians skilled in the art will recognize that mobile subscriber s may wish to access content at their wireless handset and or other similar wireless device other than those delimited prior without diluting the intent and scope of the invention of present. Further still those practitioners will also recognize that a variety of protocols including Authentication Authorization and Accounting AAA protocols will satisfy the implementation of said architecture without affecting the intent and scope of the present invention. Fundamentally the Internet Protocol IP charging and rating middleware platform and gateway system resides between the GGSN and the Master RADIUS server in a lay manner the GGSN simply presupposes the gateway system is the Master RADIUS server and vice versa.

Continuing with reference to the RADIUS Proxy Server checks the master data to confirm that the account in question is active via LDAP or RADIUS. Practitioners skilled in the art shall recognize that a variety of protocols will satisfy the implementation of said architecture without affecting the intent and scope of the present invention. Where the returned response is negative not shown an authorization reject is returned to the GGSN.

The gateway system makes a request to an Open Charging OC middleware platform and gateway system as detailed in patent application Ser. No. 10 307 335 to confirm the status of the account in question and related profile capabilities. Technicians skilled in the art will recognize that the invention of present need not be limited to the aforementioned Open Charging OC middleware platform and gateway system and other similar network implementations may be employed without diluting the intent and scope as such.

The Open Charging OC middleware platform and gateway system accesses the subscriber account server SCP removing the access charge from the account pre paid . Where the account can not support the requested charge then a negative response is returned not shown and a negative authorization is passed to the GGSN as a failed access request.

From the Unified Rating Service the user profile in question is recovered. In the preferred embodiment assuming both the account check and the profile were positive an authorization accept is returned to the GGSN via the gateway system s RADIUS Proxy server .

The gateway system preloads the said user profile and loads the rating plans detailed further in and as a result when the first user data packet is received the gateway controller already has a complete user profile built.

So thus still in reference in now whenever the mobile subscriber initiates a data session and the RADIUS Proxy Server triggers the gateway controller with the subscriber specific identification parameters such as the IP address MSISDN APN etc. said controller makes a token reservation request to OCG s Prepay Account Manager application in order to obtain a certain amount of usage quota responds with a the requested number of credits quota for consumption for a particular ID.

Simultaneously the gateway controller obtains the rating and charging information specific to the subscriber. The gateway controller then arms the IPCE with the appropriate information including MSISDN IP address the rating specific inspection criteria etc.

IPCE then internally arms the respective IP Flow Classification triggers not shown associated with the specific information. For example the Flow Classification might specify the URL s allowed for the subscriber the blocking of streaming service etc. The subscriber specific information is in addition to the regular usage statistic detectors. These generic IP Flow Classifiers perform accounting of usage on IP addresses ports protocols and maintain the user state information within the several IP flows.

Where events corresponding to these trigger points occur the IP Flow Classifiers update the Internet Protocol IP charging and rating middleware platform and gateway system accounting interface not shown which monitors the usage related to each type of data flow within the user data session.

The Internet Protocol IP charging and rating middleware platform and gateway system decrements the usage details from the allocated quota. Periodically these usage statistics are updated on the gateway controller which applies the charging to the usage information with rating information and decrements the credits reserved. Where the allocated tokens are exhausted a token confirmation report is sent to OCG s Prepay Server in order to debit the users account balance and simultaneously reserve additional credit quota and allocation of usage quotas.

The Packet Analyzer component of the IP Classification Engine IPCE instantiates and configures itself using the downloaded IP Classification Modules Registry. It creates a decision tree based on the IP Classification Modules registry for analyzing and determining packet types. and serve to delineate these processes.

When a packet is captured it is passed onto the Packet Analyzer. If the source and destination IP addresses are not blocked the Packet Analyzer obtains a copy of the packet and immediately re releases the packet into the network. Blocked packets are copied and dropped within the system. However if the source or destination IP addresses or ports are defined to be free the message is forwarded regardless of the blocking logic. Using the copy of the captured packet the Packet Analyzer determines the packet type using the decision tree of .

When the packet type is determined the Rating and Charging Component of the IP Classification Engine is notified.

The IP Classification Modules IPCM Registry is used to specify the logic for analyzing the packets. It specifies a decision tree for determining the packet type of each packet it also specifies the IP Classification module to be used for determining each packet type

As explicated earlier with reference to to enable all the above features of the Internet Protocol IP charging and rating middleware platform and gateway system the Unified Rating Service URS on the control plane i.e. service logic plane is invoked to arm Flow Classification triggers on the data plane i.e. user traffic plane . When a subscriber starts a data session the standard and subscriber specific rating information is loaded from the URS onto the IPCE through the Controllers.

Based on this rating profile the appropriate Flow Classification triggers are armed within the IPCE. During regular inspection of IP flows when a set of events corresponding to the armed triggers occurs in the data plane the control plane service logic is triggered to take control of the IP flow to perform further analysis accounting routing and control of the session.

Protocols such as FTP POP RTP RTSP and SMTP have well defined state machines where the service logic session information can indicate when a state has been reached. On the contrary HTTP does not have well defined state machines but can be inspected in a way such that service logic can indicate when a state has been reached. For example the control plane service logic has been implemented to start the counting the number and type of bytes transported after a HTTP GET Response has been detected. The accounting of packets is terminated when a TCP FIN is detected. Further refined service logic has also been implemented in the service logic of the IPCE to detect content based on Layer 7 information. For example particular internet content may have restricted access or may be free of charge.

Consider further the advances achieved by the IPCM in providing a unique way of identifying and classifying MMS traffic for rating purposes. Now MMS traffic is usually transported over the standard WAP protocol stack within a GPRS network the IP Classification Flow Monitors detect MMS traffic within the WAP protocol stack through the Content Type field within the WSP layer of the WAP protocol or the presence of the MMSC URI in the GET header of the WSP layer of the WAP protocol. All WAP messages with the same Transaction ID as the original MMS packets are considered to be part of the MMS message stream. To ensure that all packets related to a MMS message are correctly rated session management is required to correlate all traffic with the same Transaction ID in the WTP layer .

Grouping by Transaction ID is terminated by either a time based counter or the arrival of an Abort 0 x 04 PDU within the Wireless Transaction Protocol layer.

The Internet Protocol IP charging and rating middleware platform and gateway system obtains the usage accounting information not shown applies the associated rating information to calculate the incurred charge to the subscriber and decrements that from the quota allocated by the Prepaid Application Manager in the case of prepaid subscribers. When the allocated quota has been depleted or lower than a defined threshold the quota usage is confirmed with a request for more. In the event that the subscriber has no more balance in their prepaid account it is possible to selectively drop the subscriber packets or direct them to a top up site depending on the subscriber specific rating information. In the case of post paid subscribers the appropriate usage CDR s or similar type Event Records are generated for transfer to the network billing system.

