---

title: Flagging of port conditions in high speed networks
abstract: A non-intrusive condition flag is introduced into high-speed data network for flagging a fault condition without interrupting the normal operation of the network. The condition flag is chosen to be one that is relatively not germane with respect to disrupting the behavior of the ports under a particular network protocol, or that is normally ignored by the network ports and/or devices. The non-intrusive condition flag can be in the form of a marker represented by designating new, currently undefined, Ordered Sets that would not cause the ports to disrupt network behavior. The marker is represented by repeating the same designated Ordered Set twice in sequence, to give the marker fault tolerance and prevent re-transmission. Ordered Sets may be chosen to identify a segment stall condition, a port busy condition, or a user defined condition in a FC network.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08111610&OS=08111610&RS=08111610
owner: Emulex Design & Manufacturing Corporation
number: 08111610
owner_city: Costa Mesa
owner_country: US
publication_date: 20080125
---
This invention relates to storage network systems and more particularly to flagging port conditions in high speed data network systems.

In information exchange networks data transfer among network devices may be based on a number of available protocols. Network devices may include computer systems e.g. workstations servers etc. peripheral devices e.g. mass storage systems input output systems etc. switches and other general function or function specific systems and devices. The network devices communicate via data transfer protocols in accordance with several established industry standards such as Fibre Channel FC Internet Small Computer Systems Interface iSCSI Ethernet etc.

FC data transfer protocol is a gigabit speed network protocol e.g. operating on the order of 1 to 10 Gbits s or higher which has been effectively adopted for Storage Area Networks SANs connecting servers and storage systems at a plurality of ports within the network. A port in FC terminology is any entity that actively communicates over the network not necessarily a hardware port. A port is usually implemented in a device such as a disk storage device a host bus adaptor HBA on a server or a FC switch.

FC supports three different topologies Point to Point FC P2P Fabric Attached or Switched FC SW and Arbitrated Loop FC AL . The FC P2P topology attaches two devices directly. The FC SW topology attaches a device directly to a switch fabric. The FC AL topology attaches devices in a loop or ring.

Arbitrated Loop has become the most dominant FC topology. While it is a cost effective way of connecting multiple ports in a single network without the need of a fabric switch it is also the most complex among the FC topologies. Unlike the other two topologies the media is shared among the devices limiting each device s access. For a Loop to operate all devices must be Loop devices.

In FC Ordered Sets are used to distinguish FC control information from data which may include a frame delimiter a primitive signal or a primitive sequence. Many Ordered Sets are constantly going around the Loop. For example when a device is ready to transmit data in an Arbitrated Loop it first must arbitrate and gain control of the Loop. Once the device has gained control of the Loop it can communicate with other devices by transmitting an Open OPN Primitive Signal to a target device on another port opening communication with that device on the Loop. Once this happens there essentially exists point to point communication between the two devices. All other devices in between simply repeat the data.

In the FC AL topology because all devices are in a loop or ring failure of one device could cause all activity on the loop to be interrupted. Specifically before an Arbitrated Loop is usable it must be initialized. Loop initialization generally involves transmission of a Loop Initialization Primitive Sequence LIP . LIP is transmitted by a FC port often referred to as an L Port after it powers on. However in the past LIP is also transmitted by a FC port when it detects a fault at a port. In such circumstance the LIP will propagate around the Loop triggering all other ports to transmit LIP as well. Each and every port on the Loop needs to be re initialized. At this point the entire Loop network would be down causing the Loop to be unusable. The LIP flag transmitted in the event of a port condition is therefore disruptive to the operation of the entire Loop.

Further under FC AL topology in the event of a port condition it can be difficult to pin point the source of such condition by probing the network wiring. For relatively low data transmission bandwidth e.g. less than 1 Gbits s the port condition is not difficult to identify. However for relatively higher data transmission bandwidth e.g. at 2 to 10 Gbits s or higher it would be challenging to identify port condition. While current tools such as analyzers have made it easier to capture filter and trigger information related to port conditions for certain port conditions it is still difficult to identify the source on an analyzer trace. Due to the difficulty of locating port conditions on a trace extra resources are required to be spent in the field during network diagnostics and in laboratories during network development analyzing large amounts of data to determine when a fairly simple port condition occurred. The issues with identifying port conditions have been further discussed in published international patent application no. PCT US99 26924 PCT Publication No. WO00 30293 which has been commonly assigned to the assignee of the present application.

Emulex s InSpeed technology is an advanced switching architecture comprising a non blocking crossbar switch with unique loop port logic resulting in a single chip capable of handling multiple FC devices in embedded SOC switch on a chip blade and box environments. InSpeed technology provides tools advancing reliability availability serviceability and scalability e.g. diagnostics capabilities that can be used to maintain and troubleshoot back end storage systems which improves storage reliability. InSpeed through its RAS capability has the ability to detect port conditions such as port busy conditions and detect and correct segment stalls. However the existing InSpeed technology does not have an effective way of flagging port conditions.

It is therefore desirable to provide flagging of port conditions in network systems operating at high speed network data transfer protocols.

The present invention is directed to a system and method for flagging port conditions in a high speed network. In a basic aspect of the present invention a non intrusive condition flag is introduced into the data network for tracing the condition without interrupting the normal operation of the network. Flagging as used in the context of the present invention includes identifying the port condition and or the source of such condition. The condition flag is chosen to be one that is relatively not germane with respect to the control e.g. initialization of ports under a particular network protocol or that is normally ignored by other network ports and or devices except for those ports programmed or enabled to recognize the flag e.g. by the API that controls switch ASIC.

In one embodiment of the present invention directed to FC AL network the non intrusive condition flag is in the form of a marker represented by currently undefined Ordered Sets that would not cause the ports to disrupt network behavior. In one embodiment Ordered Sets may be chosen to identify a segment stall condition requiring a close CLS and remove connect operation a port busy condition requiring a close CLS operation by the switch or a particular user defined condition in a FC network.

The present description is of the best presently contemplated mode of carrying out the invention. This description is made for the purpose of illustrating the general principles of the invention and should not be taken in a limiting sense. The scope of the invention is best determined by reference to the appended claims. This invention has been described herein in reference to various embodiments and drawings. It will be appreciated by those skilled in the art that variations and improvements may be accomplished in view of these teachings without deviating from the scope and spirit of the invention.

The present invention can find utility in a variety of implementations without departing from the scope and spirit of the invention as will be apparent from an understanding of the underlying principles. By way of examples and not limitation for purposes of describing the inventive aspects of the present invention references are made throughout this description of the invention to a FC AL network environment and in particular a storage area network SAN . However it is understood that the present invention may be extended to be applied to other high speed networks operating under other network protocols and or multi protocol network environments without departing from the scope and spirit of the present invention.

FC AL networks are well documented in the state of the art. is a schematic diagram illustrating an embodiment of a FC AL network that deploys the condition flag in accordance with the present invention. The FC AL standard defines a topology that allows many network devices to be connected together in a ring configuration. Each device has a transmitter and a receiver. The transmitter of one device is connected to the receiver of another device and so on until the last device s transmitter is connected back to the first device s receiver. In the illustrated embodiment the FC AL network includes Nodes N to N at which devices are located and a switch having Ports to to which the nodes are connected. Some ports have more than one node connected to them. The interconnection between devices may be direct or via the ports in the switch . The switch effectively connects the ports in a ring configuration. In the illustrated embodiment Ports and are electronically and or logically interconnected in a sequence in a ring with Port connected back to Port as schematically shown in . Accordingly via the Ports and the Nodes N to N are connected in a ring configuration to form the Arbitrated Loop .

The FC AL network may support data communication based on one or more protocols in accordance with different established network data transfer standards or architectures and may include separate and or interconnected sub networks that support one or more data transfer protocols. In one aspect of the present invention the supported protocols comprise storage level protocols e.g. for SANs .

Details of various hardware and software components comprising the SAN and or FC AL network are not shown in the figures such as additional switches hubs routers gateways switches etc. as they are known in the art. Further it is understood that access to the SAN by the network devices may be via physical transmission medium e.g. optic fiber suitable for the particular network data transfer protocols supported by the network devices.

Referring to for purpose of illustration and not limitation of the present invention the SAN is configured to include a Switch that forms a part of the Arbitrated Loop which switch incorporates the InSpeed technology developed by Emulex Corporation the assignee of the present invention. The Switch corresponds to the switch in . Emulex s InSpeed technology is an advanced switching architecture comprising a non blocking crossbar switch with unique loop port logic resulting in a single chip capable of handling multiple FC devices in embedded SOC switch on a chip blade and box environments. InSpeed technology provides tools advancing reliability availability serviceability and scalability e.g. diagnostics capabilities that can be used to maintain and troubleshoot back end storage systems which improves storage reliability. The details of the InSpeed technology will not be discussed herein so as not to obscure the disclosure of the present invention but will only be discussed where appropriate below to the extent to provide an embodiment to facilitate a better understanding of the present invention. The InSpeed technology has been well documented including for example the following publications White Paper entitled Improving Storage System Resiliency Stealth Intelligent Change Manager author unknown Emulex Publication No. 07 216 10 06 While Paper entitled Advancing Storage Reliability with InSpeed Technology authored by Thomas Hammond Doel Director of Technical Marketing October 2002 Emulex Publication No. 04 170 02 04 While Paper entitled Introducing InSpeed Technology Breaking New Cost Performance Barrier in Storage Networking authored by Thomas Hammond Doel Director of Technical Marketing January 2002 published by Vixel Corporation which has been acquired by Emulex Vixel Part 00045036 002 Rev. A and the following patent publications by the assignee of the present invention U.S. Pat. No. 6 118 776 U.S. Patent Application Publication No. US2002 0196773A1 U.S. Patent Application Publication No. US2003 0086377A1 U.S. Patent Application Publication No. US2003 0095549A1 U.S. Patent Application Publication No. US2004 0081187A1 International Patent Application Publication No. WO00 30293.

In the event an Initiator server wishes to open communication with a Target storage device in the Arbitrated Loop an Initiator Target interaction process is undertaken. Referring to the interaction diagram of when the Initiator is ready to access the Target in the Arbitrated Loop the Initiator must first arbitrate and gain control of the Loop via its L Port in order to open communication with another port on the Loop . Specifically once the Initiator has gained control of the Loop it transmits via the L Port that has won the arbitration process an Open OPN Primitive Signal to the Target on another port in the Loop via the Switch so as to open the L Port at the Target . The Target responds with a RRDYs Primitive Signal to the Initiator via the Switch to indicate that the Target is ready to accept command or data from the Initiator . Communication is open between the Initiator and the Target at this time where point to point communication essentially exists between the Initiator and the Target . In particular the Initiator sends a FC frame command or data to the Target via the Switch . All other network devices in between along the Loop simply repeat the data command between the Initiator and the Target .

After which under normal operations the Initiator should send via its L Port a Close CLS Primitive Signal to the Target to close communication with the L Port at the Target . This frees bandwidth along the Loop for communications between other network devices. However in the event the CLS is not sent by the Initiator the interaction between the Initiator and the Target idles waiting for the CLS. As a result a segment stall condition occurs.

In accordance with the present invention the Switch is configured to introduce a non intrusive marker in the form of a condition flag into Loop for tracing the fault condition without interrupting the normal operation of the FC AL network. The condition flag is chosen to be one that is relatively not germane with respect to the control of initialization of ports under a particular network protocol or that is normally ignored by other network ports and or devices. In particular in the embodiment directed to FC AL network the non intrusive condition flag is in the form of a marker represented by currently undefined Ordered Sets that would not cause the ports to disrupt network behavior. In one embodiment Ordered Sets may be chosen to identify a segment stall condition a port busy condition or a user defined condition in a FC AL network.

In the event of a segment stall condition as described above the condition flag may be chosen to identify the segment stall condition which may be followed by a CLS and remove connect operation in the switch. Referring to after a predefined timeout period in which CLS is expected from the Initiator but did not occur the OS Generator in the Port Logic of the Switch issues two Segment Stall Flag Ordered Sets followed by a CLS as shown in in sequence to the Target . The Target responds by ignoring the flag and issuing a CLS Primitive Signal to the Initiator via the Switch to close communication with the L Port at the Initiator .

As the Receiver of the Port Logic receives the flagged Ordered Sets the Ordered Sets are detected by the OS Decode which can be logged and will be removed and replaced with the current fill word in conformance to fibre channel protocol.

The condition flag markers are defined by two flag Ordered Sets which are currently undefined Ordered Sets that are not germane to FC protocol and which are normally ignored by routers and switches. By providing the condition flag marker in real time the fault condition is flagged in real time so it can be used for tracing the source of the fault condition in the network. The marker may be correlated to time information that is provided by the Application Programming Interface API of the Switch . By using the Ordered Sets twice in a row they can be distinguished from an accidental flag situation thereby error tolerant. In one embodiment when the condition flag is defined by the same Ordered Set only twice in sequence as opposed to more than twice in sequence retransmission can be prevented.

If the Initiator that is experiencing the segment stall condition is Node N at Port in and the Target in open communication with the Initiator is Node N at Port the marker i.e. consisting of two Ordered Set flags in sequence is transmitted to Target by the switch core corresponding to Loop . By using Ordered Sets that are currently undefined all attached nodes will ignore them per FC protocol except for the nodes programmed to recognize such marker. If Nodes N and N otherwise recognize the marker defined by currently defined Ordered Sets they can log and re transmit the marker. The logged marker provides First Time Data Capture information for flagging the source of the port condition. If they do not recognize the marker they will ignore it and not re transmit it. Should Target retransmits the condition flagged marker to another device at Node N and should that device at Node N retransmits the marker to Port i.e. Node for some reason failed to follow protocol and retransmitted the marker comprising the condition flagged Ordered Sets Port will scrub the marker and not transmit it to the switch core e.g. replace with the current fill word .

In further embodiments Ordered Sets may be chosen to represent condition flags to identify a target port busy condition or a user defined condition in a FC AL network. For example a currently undefined Ordered Set may be chosen to define a Port Busy Flag which is issued to the Target twice in a row by the Switch to represent a condition flag in the event an OPN is received by the Switch for a port that is busy. A CLS is returned by the Target .

For a user defined condition a currently undefined Ordered Set may be chosen to define a User Defined Flag which is issued to the Target twice in a row by the Switch to represent a condition flag in the event a predefined error occurs before resuming transmitting the current fill word.

The specific Ordered Sets can be chosen at the time of designing the specific ASIC structure for the switch.

The present invention has been described above in terms of schematic and functional diagrams. It is understood that unless otherwise stated to the contrary herein one or more functions and components may be integrated in a single physical device with associated firmware and or software control or one or more functions and components may be implemented in separate physical devices with separate firmware and or software control without departing from the scope and spirit of the present invention.

It is appreciated that detailed discussion of the actual implementation of each functional component is not necessary for an enabling understanding of the invention. The actual implementation is well within the routine skill of a programmer and system engineer with basic understanding of high speed network design and various protocol specifications given the disclosure herein of the system attributes functionality and inter relationship of the various functional components in the system. A person skilled in the art applying ordinary skill can practice the present invention without undue experimentation.

While the invention has been described with respect to the described embodiments in accordance therewith it will be apparent to those skilled in the art that various modifications and improvements may be made without departing from the scope and spirit of the invention. Accordingly it is to be understood that the invention is not to be limited by the specific illustrated embodiments but only by the scope of the appended claims.

